@{
    ViewBag.Title = "Index";
    Layout = null;
}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <style type="text/css">
        body
        {
            margin: 0;
            padding: 0;
            font-size: 14px;
            font-family: "微软雅黑";
            list-style: none;
            font-weight: normal;
        }
        h1, h2, h3, h4, h5, p, ul, li, div, span, dl, dd, dt, img, button, input, tr, td, table
        {
            margin: 0;
            padding: 0;
            border: none;
            list-style: none;
            font-weight: normal;
        }
        #btp-edui-dialog-image
        {
          @*@*  border: 1px solid #acacac;
            box-shadow: 2px 2px 5px #d3d6da;*@
            outline: 0;
            background-color: #fff;
             z-index: 7;
            position: fixed;
            top: 0;
            left: 0;
        }
        .btp-edui-modal-header
        {
            padding: 5px 10px;
            border-bottom: 1px solid #eee;
        }
        
        .btp-edui-close
        {
            float: right;
            width: 20px;
            height: 20px;
            margin-top: 2px;
            padding: 1px;
            border: 0;
            background: url('/Images/close.png') no-repeat center center;
            cursor: pointer;
        }
        .btp-edui-title
        {
            font-size: 1.17em;
            -webkit-margin-before: 1em;
            -webkit-margin-after: 1em;
            -webkit-margin-start: 0px;
            -webkit-margin-end: 0px;
            margin: 0;
            line-height: 25px;
            display: block;
        }
        .btp-edui-dialog-image-body
        {
            position: relative;
            max-height: 400px;
            font-size: 12px;
            overflow-y: auto;
            width: 700px;
            height: 408px;
        }
        #btp-edui-image-Jwrapper
        {
            font-size: 12px;
            margin: 15px;
        }
        .btp-edui-tab-nav
        {
            display: block;
            -webkit-margin-before: 1em;
            -webkit-margin-after: 1em;
            -webkit-margin-start: 0px;
            -webkit-margin-end: 0px;
            -webkit-padding-start: 40px;
            margin: 0;
            padding: 0;
            border-bottom: 1px solid #ddd;
            list-style: none;
            height: 35px;
        }
        .btp-edui-tab-nav li
        {
            display: list-item;
            text-align: -webkit-match-parent;
            float: left;
            margin-bottom: -1px;
        }
        .btp-edui-tab-item.active .btp-edui-tab-text
        {
            border: 1px solid #ddd;
            border-bottom-color: transparent;
            background-color: #fff;
            padding: 8px 12px;
            color: #555;
            cursor: default;
            display: block;
            line-height: 18px;
        }
        .btp-edui-tab-item .btp-edui-tab-text
        {
            display: block;
            padding: 8px 12px;
            line-height: 18px;
            border: 1px solid transparent;
            color: #08c;
            text-decoration: none;
            outline: 0;
        }
        a:-webkit-any-link
        {
            color: -webkit-link;
            text-decoration: underline;
            cursor: auto;
        }
        a:link, a:visited
        {
            text-decoration: none;
        }
        .btp-edui-tab-content
        {
        }
        #btp-edui-image-Jlocal
        {
            display: block;
            padding: 1px;
            position: relative;
            background-color: #fff;
        }
        #btp-edui-image-Jcontent
        {
            height: 330px;
            width: 100%;
            position: relative;
        }
        #btp-edui-image-Jmask
        {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            text-align: center;
            line-height: 300px;
            color: #000;
            font-size: 14px;
            font-weight: bold;
            opacity: 0.6;
        }
        #btp-edui-image-JdragTip
        {
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: 30px;
            margin-left: -60px;
            color: #222;
            font-size: 14px;
            text-shadow: 0px 2px 3px #555;
        }
        #btp-edui-image-Jupload1
        {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 44px;
            height: 38px;
            margin-top: -19px;
            margin-left: -22px;
        }
        #btp-edui-image-Jupload1 .btp-edui-image-icon
        {
            display: inline-block;
            width: 44px;
            height: 38px;
            background-image: url('/Images/upload1.png');
        }
        #btp-edui-image-Jupload1 .btp-edui-image-icon.hover
        {
            background-position: -50px 0;
        }
        .btp-edui-image-item
        {
            position: relative;
            float: left;
            width: 120px;
            height: 120px;
            border: 1px solid #CCC;
            cursor: default;
            margin: 5px 0 0 5px;
        }
        .btp-edui-image-item .btp-edui-image-close
        {
            position: absolute;
            right: 0;
            background: url('/Images/close.png');
            width: 17px;
            height: 17px;
            cursor: pointer;
            z-index: 1;
        }
        .btp-edui-image-pic
        {
            position: absolute;
            top: 14.6667px;
            left: 0.16667px;
            height: 91px;
            width: 120px;
            cursor: default;
        }
        .btp-edui-image-upload2
        {
            position: relative;
            float: left;
            width: 120px;
            height: 120px;
            margin: 5px 0 0 5px;
        }
        .btp-edui-image-upload2 .btp-edui-image-icon
        {
            display: inline-block;
            width: 120px;
            height: 120px;
            background-image: url('/Images/upload2.png');
        }
        .btp-edui-image-form
        {
            position: absolute;
            left: 0px;
            top: 0px;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .btp-edui-image-mask
        {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            text-align: center;
            line-height: 300px;
            color: #000;
            font-size: 14px;
            font-weight: bold;
            opacity: 0.6;
            filter: alpha(opacity=60);
        }
        .btp-edui-image-dragTip
        {
            position: absolute;
            display: none;
            top: 50%;
            left: 50%;
            margin-top: 30px;
            margin-left: -60px;
            color: #222;
            font-size: 14px;
            text-shadow: 0px 2px 3px #555;
        }
        .btp-edui-image-upload1
        {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 44px;
            height: 38px;
            margin-top: -19px;
            margin-left: -22px;
        }
        #btp-edui-image-JimgSearch
        {
            padding: 1px;
            position: relative;
            display: none;
            background-color: #fff;
        }
        .btp-edui-image-searchBar
        {
            margin: 10px;
        }
        .btp-edui-image-searchRes
        {
            height: 280px;
            overflow: auto;
        }
        .btp-edui-modal-footer
        {
            float: right;
            padding: 5px 15px 15px;
            overflow: hidden;
        }
        .btp-edui-image-form .btp-edui-image-file
        {
            width: 100%;
            height: 100%;
            filter: alpha(opacity=0);
        }
        .btp-edui-modal-footer
        {
            float: right;
            padding: 5px 15px 15px;
            overflow: hidden;
        }
        .btp-edui-modal .btp-edui-modal-tip
        {
            color: red;
            position: absolute;
            bottom: 10px;
            left: 10px;
            height: 30px;
            line-height: 30px;
            display: none;
        }
        .btp-edui-modal-footer .btp-edui-btn
        {
            float: left;
            height: 24px;
            width: 96px;
            margin: 0 10px;
            background-color: #fff;
            padding: 0;
            border: 1px solid #ababab;
            font-size: 12px;
            line-height: 24px;
            text-align: center;
            cursor: pointer;
        }
    </style>
    <script type="text/javascript" src="/Scripts/jquery.js"></script>
    <script type="text/javascript">
        try { document.domain = 'iuoooo.com'; } catch (e) { }
    </script>
    <script type="text/javascript">
        //条件限制
        var checkObj = {};
        checkObj.Url = "/Handler/ImgBatchUploadHandler.ashx";
        checkObj.Width = 640;
        checkObj.Height = 480;
        checkObj.Size = 50;
        checkObj.Accept = [".gif", ".png", ".jpg", ".jpeg", ".bmp"];
        checkObj.UploadAccept = ["image/gif", "image/png", "image/jpg", "image/jpeg", "image/bmp"];
        checkObj.Count = 5;
        checkObj.iCount = 0;  //已上传了的数量

        //初始化方法，需要使用页调用
        function load() {
            var obj = parent.loadBatchParam();
            if (obj) {
                if (obj.Width) {
                    checkObj.Width = obj.Width;
                }
                if (obj.Heigh) {
                    checkObj.Height = obj.Heigh;
                }
                if (obj.Size) {
                    checkObj.Size = obj.Size;
                }
                if(obj.fileSizeLimit){
                    checkObj.fileSizeLimit = obj.fileSizeLimit;
                }
                if (obj.Accep) {
                    checkObj.Accept = obj.Accep;
                    checkObj.UploadAccept = [];
                    for (var i = 0; i < obj.Accep.length; i++) {
                        checkObj.UploadAccept.push(obj.Accep[i].replace(/\./, "image/"));
                    }
                }
                if (obj.Count) {
                    checkObj.Count = obj.Count;
                }
                if (obj.iCount) {
                    checkObj.iCount = obj.iCount;
                }
                if (obj.Url) {
                    checkObj.Url = obj.Url;
                }
                checkObj.Url = checkObj.Url + "?editorid=imgBatchUpload";
            }
        }
        function checkUpload(file, size) {
            if (checkObj.Count <= checkObj.iCount) {
                alert("最多只能上传" + checkObj.Count + "张图片");
                return false;
            }
            if (size > checkObj.fileSizeLimit * 1000) {
                alert("最大只能上传" + checkObj.fileSizeLimit + "KB");
                return false;
            }
            if (file) {

            }
            return true;
        }
        function checkDrag(fileList) {            
            if (checkObj.Count < checkObj.iCount + fileList.length) {
                alert("最多只能上传" + checkObj.Count + "张图片");
                return false;
            }
            for(var i=0;i<fileList.length;i++){
                if(fileList[i].size>checkObj.fileSizeLimit * 1000) {
                    alert("最大只能上传" + checkObj.fileSizeLimit + "KB");
                    return false;
                }
            }
            return true;
        }
        function cancel() {
            parent.uploadImgBatchClose();
        }
        function confirm() {
            if (!$("#btp-edui-image-Jcontent .btp-edui-image-upload-item")) {
                parent.uploadImgBatchClose();
                return;
            }
            var objResult = {};
            objResult.Url = [];

            $("#btp-edui-image-Jcontent .btp-edui-image-upload-item").each(function () {
                var imgUrl = $(this).children("img").attr("src");
                objResult.Url.push(imgUrl);
            });

            parent.uploadImgBatchConfirm(objResult);
        }     
    </script>
    <script type="text/javascript">

        function showDrag() {
            $("#btp-edui-image-Jupload2").hide();
            $("#btp-edui-image-JdragTip").show();
            $("#btp-edui-image-Jupload1").show();
        }
        function showAddImg() {
            $("#btp-edui-image-JdragTip").hide();
            $("#btp-edui-image-Jupload1").hide();
            $("#btp-edui-image-Jupload2").show();
        }
        function AddImg(img, state) {
            if (state != "SUCCESS") {
                alert(state);
                return;
            }

            var imgList = img.split(",");
            if (checkObj.Count < imgList.length + checkObj.iCount) {
                alert("最多只能上传" + checkObj.Count + "张图片");
                return;
            }

            if (imgList.length > 0) {
                showAddImg();
            }
            for (var i = 0; i < imgList.length; i++) {
                var imgDiv = $("#imgTemplate").html().replace("src=\"\"", "src=\"" + imgList[i] + "\"");
                $("#btp-edui-image-Jupload2").before(imgDiv);
            }
            checkObj.iCount = imgList.length + checkObj.iCount;
            $("#uploadFile").val("");
            $("#uploadFile2").val("");
        }
        function initail() {
            //action
            $(".btp-edui-image-form").attr("action", checkObj.Url);
            //input accept
            $("input[name=upfile]").attr("accept", checkObj.UploadAccept.join(","));
            //以下为其它要传的参数
            $("input[name=width]").val(checkObj.Width);
            $("input[name=height]").val(checkObj.Height);
            $("input[name=size]").val(checkObj.Size);
            $("input[name=accept]").val(checkObj.Accept.join(","));

            if (!($.browser.msie && $.browser.version <= 9)) {
                $("#btp-edui-image-JdragTip").css("display", "block");
                enableDrag();
                showDrag();
            }
            else {
                showAddImg();
            }
        }
        function createImgBase64(img, file) {
            if ($.browser.webkit) {
                //Chrome8+
                img.src = window.webkitURL.createObjectURL(file);
            } else if ($.browser.gecko) {
                //FF4+
                img.src = window.URL.createObjectURL(file);
            } else {
                //实例化file reader对象
                var reader = new FileReader();
                reader.onload = function (e) {
                    img.src = this.result;
                };
                reader.readAsDataURL(file);
            }
        }
        function enableDrag() {
            $("#btp-edui-image-Jcontent").live("drop", function (e) {
                //获取文件列表
                var fileList = e.originalEvent.dataTransfer.files;
                //验证
                if (!checkDrag(fileList)) {
                    return;
                }
                var img = document.createElement('img');
                var hasImg = false;
                $.each(fileList, function (i, f) {
                    if (/^image/.test(f.type)) {
                        createImgBase64(img, f);
                        var xhr = new XMLHttpRequest();
                        xhr.open("post", checkObj.Url + "&type=ajax", true);
                        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");

                        //模拟数据
                        var fd = new FormData();
                        fd.append("file", f);
                        fd.append("width", checkObj.Width);
                        fd.append("height", checkObj.Height);
                        fd.append("size", checkObj.Size);
                        fd.append("accept", checkObj.Accept.join(","));

                        xhr.send(fd);
                        xhr.addEventListener('load', function (e) {
                            var drayData = e.target.response;
                            var drayResult = eval("(" + drayData + ")");
                            if (drayResult.State == 1) {
                                alert(drayResult.StateTest);
                            }
                            else if (drayResult.State == 0) {
                                AddImg(drayResult.FilesList, "SUCCESS");
                                if (i == fileList.length - 1) {
                                    $(img).remove()
                                }
                            }
                        });
                        hasImg = true;
                    }
                });
                if (hasImg) {
                    e.preventDefault();
                }
            });
        }
    </script>
    <script type="text/javascript">
        $(function () {
            //阻止浏览器默认行。 
            $(document).on({
                dragleave: function (e) {    //拖离 
                    e.preventDefault();
                },
                drop: function (e) {  //拖后放 
                    e.preventDefault();
                },
                dragenter: function (e) {    //拖进 
                    e.preventDefault();
                },
                dragover: function (e) {    //拖来拖去 
                    e.preventDefault();
                }
            });
            $("#uploadFile").live("change", function () {
                //验证
                if (!checkUpload($(this).val(), $(this)[0].files[0].size)) {
                    return;
                }
                $(this).parents("form").submit();
            });
            $("#uploadFile2").live("change", function () {
                //验证
                if (!checkUpload($(this).val(), $(this)[0].files[0].size)) {
                    return;
                };
                $(this).parents("form").submit();
            });
            //删除图片时
            $(".btp-edui-image-close").live("click", function () {
                $(this).parent(".btp-edui-image-upload-item").remove();
                if (!($.browser.msie && $.browser.version <= 9)) {
                    if ($("#btp-edui-image-Jupload2").siblings(".btp-edui-image-upload-item").length == 0) {
                        showDrag();
                    }
                }
            });
            //图标颜色
            $("#btp-edui-image-Jupload1").mouseenter(function () {
                $("#btp-edui-image-Jupload1 .btp-edui-image-icon").addClass("hover");
            }).mouseout(function () {
                $("#btp-edui-image-Jupload1 .btp-edui-image-icon").removeClass("hover");
            });
            //上传前验证
            $("#btp-edui-image-Jupload2").live("click", function () {
                if (!checkUpload("")) {
                    return false;
                }
            });
            //上传前验证
            $("#btp-edui-image-upload1").live("click", function () {
                if (!checkUpload("")) {
                    return false;
                }
            });
            //关闭
            $("#btp-cancel").live("click", function () {
                cancel();
            });
            //确定
            $("#btp-ok").live("click", function () {
                confirm();
            });
            load();
            initail();
        });
    </script>
</head>
<body>
    <div id="btp-edui-dialog-image" style="width: 700px; height: 482px; overflow: hidden;">
        <div class="btp-edui-modal-header" style="display: none">
            <div class="btp-edui-close">
            </div>
            <h3 class="btp-edui-title">
                图片</h3>
        </div>
        <div class="btp-edui-dialog-image-body">
            <div id="btp-edui-image-Jwrapper">
                <ul class="btp-edui-tab-nav" style="display: none">
                    <li class="btp-edui-tab-item active"><a href="#btp-edui-image-Jlocal" class="btp-edui-tab-text">
                        本地上传</a></li>
                    <li class="btp-edui-tab-item"><a href="#btp-edui-image-JimgSearch" class="btp-edui-tab-text">
                        网络图片</a></li>
                </ul>
                <div style="color: #007fff; font-size: 16px; line-height: 26px; text-align: center;">
                    请上传JPG、PNG格式的图片，建议图片尺寸：640*640,小于50K</div>
                <div class="btp-edui-tab-content">
                    <div id="btp-edui-image-Jlocal" class="btp-edui-tab-pane active">
                        <div id="btp-edui-image-Jcontent">
                            <div class="btp-edui-image-item btp-edui-image-upload2" id="btp-edui-image-Jupload2">
                                <span class="btp-edui-image-icon"></span>
                                <form class="btp-edui-image-form" method="post" enctype="multipart/form-data" target="up"
                                action="/Handler/ImgBatchUploadHandler.ashx?editorid=myUploadImgEditor">
                                <input name="width" type="hidden" />
                                <input name="height" type="hidden" />
                                <input name="size" type="hidden" />
                                <input name="accept" type="hidden" />
                                <input name="type" type="hidden" value="form" />
                                <input style="filter: alpha(opacity=0);" class="btp-edui-image-file" type="file"
                                    id="uploadFile" hidefocus="" name="upfile" accept="image/gif,image/jpeg,image/png,image/jpg,image/bmp"></form>
                                <iframe id="upload1" name="up" style="display: none"></iframe>
                            </div>
                        </div>
                        <div class="btp-edui-image-mask" id="btp-edui-image-Jmask">
                            Loading....</div>
                        <div id="btp-edui-image-JdragTip" class="btp-edui-image-dragTip" style="display: none;">
                            支持图片拖拽上传</div>
                        <div class="btp-edui-image-upload1" id="btp-edui-image-Jupload1" style="display: none;">
                            <span class="btp-edui-image-icon"></span>
                            <form class="btp-edui-image-form" method="post" enctype="multipart/form-data" target="up2"
                            action="/Handler/ImgBatchUploadHandler.ashx?editorid=myUploadImgEditor">
                            <input name="width" type="hidden" />
                            <input name="height" type="hidden" />
                            <input name="size" type="hidden" />
                            <input name="accept" type="hidden" />
                            <input name="type" type="hidden" value="form" />
                            <input style="filter: alpha(opacity=0);" class="btp-edui-image-file" type="file"
                                id="uploadFile2" hidefocus="" name="upfile" accept="image/gif,image/jpeg,image/png,image/jpg,image/bmp"></form>
                            <iframe id="upload2" name="up2" style="display: none"></iframe>
                        </div>
                    </div>
                    <div id="btp-edui-image-JimgSearch" class="btp-edui-tab-pane" style="display: none">
                        <div class="btp-edui-image-searchBar">
                            <table>
                                <tbody>
                                    <tr>
                                        <td>
                                            <input class="btp-edui-image-searchTxt" id="btp-edui-image-JsearchTxt" type="text">
                                        </td>
                                        <td>
                                            <div class="btp-edui-image-searchAdd" id="btp-edui-image-JsearchAdd">
                                                添加</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="btp-edui-image-searchRes" id="btp-edui-image-JsearchRes">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="btp-edui-modal-footer">
            <div class="btp-edui-modal-tip">
            </div>
            <div id="btp-ok" class="btp-edui-btn btp-edui-btn-primary">
                确认</div>
            <div id="btp-cancel" class="btp-edui-btn">
                取消</div>
        </div>
    </div>
    <div id="imgTemplate">
        <div class="btp-edui-image-item btp-edui-image-upload-item">
            <div class="btp-edui-image-close">
            </div>
            <img src="" class="btp-edui-image-pic">
        </div>
    </div>
</body>
</html>
