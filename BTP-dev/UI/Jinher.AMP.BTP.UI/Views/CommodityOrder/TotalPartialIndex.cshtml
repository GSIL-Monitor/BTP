@using System
@using System.Collections.Generic
@using System.Linq
@using System.Web
@{
    Layout = null;
    List<Jinher.AMP.BTP.Deploy.CustomDTO.CommodityOrderVM> commodityOrderList = ViewBag.commodityOrderList;
    List<Jinher.AMP.BTP.Deploy.CustomDTO.CommodityOrderMoneyToModelDTO> moneyToList = ViewBag.MoneyToList;

    List<int> directArrivalPayments = Jinher.AMP.BTP.UI.Models.PaySourceVM.GetDirectArrivalPayment();
    string isShowChangeExp = "0";
    if ((ViewBag.IsOrg == null) || (ViewBag.IsOrg != null && ViewBag.BTPOrderStateUpd != null && ViewBag.IsOrg && ViewBag.BTPOrderStateUpd))
    {
        isShowChangeExp = "1";
    }
    string _objstr = null;
    List<string> objstr = ViewBag.objstr;
    foreach (var item in objstr)
    {
        _objstr += item + ",";
    }
    if (string.IsNullOrWhiteSpace(_objstr))
    {
        _objstr = "没有权限";
    }
}
@helper getEsAppName(Guid? esAppId, List<Jinher.AMP.BTP.Deploy.CustomDTO.CommodityOrderMoneyToModelDTO> moneyToList, Jinher.AMP.BTP.Deploy.CustomDTO.CommodityOrderVM commodityOrderVM)
    {
        string appName = "";
        string name = "";
        if (esAppId.HasValue)
        {
            List<int> directArrivalPayments = Jinher.AMP.BTP.UI.Models.PaySourceVM.GetDirectArrivalPayment();
            if (moneyToList != null)
            {

                bool setAppName = false;
                foreach (Jinher.AMP.BTP.Deploy.CustomDTO.CommodityOrderMoneyToModelDTO item in moneyToList)
                {
                    if (!setAppName && commodityOrderVM.AppId == item.EsAppId)
                    {
                        appName = item.EsAppName.ToString();
                        setAppName = true;
                    }
                    if (item.EsAppId == esAppId.Value)
                    {
                        name = item.EsAppName.ToString();
                        break;
                    }
                }
            }
            if (commodityOrderVM.AppId == esAppId.Value)
            {
    <text><div EsAppId='@esAppId.Value'>@appName</div></text>
            }
            else if (!string.IsNullOrWhiteSpace(name))
            {
                if (directArrivalPayments.Contains(commodityOrderVM.Payment))
                {
    <text><div EsAppId='@esAppId.Value'>@name</div></text>
                }
                else
                {
    <text><div EsAppId='@esAppId.Value'>@appName</div></text>
                }
            }
            else
            {
                if (!directArrivalPayments.Contains(commodityOrderVM.Payment))
                {
    <text><div EsAppId='@esAppId.Value'>@appName</div></text>
                }
            }
        }
}
@helper getTimeState(Jinher.AMP.BTP.Deploy.CustomDTO.CommodityOrderVM order)
    {
        switch (order.State)
        {
            case 0:
    <text>提交订单时间：@order.SubTime</text>
            break;
            case 1:
            if (order.Payment != 1)
            {
    <text>付款时间：@order.PaymentTime</text>
            }
            else
            {
    <text>提交订单时间：@order.SubTime</text>
            }
            break;
            case 2:
    <text>发货时间：@order.ShipmentsTime</text>
          break;
            case 3:
          switch (order.StateAfterSales)
          {
              case -1:
              case 3:
    <text>成交时间：@order.ConfirmTime</text>
          break;
              case 5:
    <text>申请退款时间：@order.RefundTime</text>
            break;
              case 7:
    <text>交易失败时间：@order.ModifiedOnServiceAfterSales</text>
            break;
              case 10:
    <text>达成协议时间：@order.AgreementTime</text>
            break;
              case 12:
    <text>达成协议时间：@order.ModifiedOnServiceAfterSales</text>
            break;
              case 13:
    <text>达成协议时间：@order.ModifiedOnServiceAfterSales</text>
            break;
              case 15:
    <text>解冻时间：@order.ModifiedOnServiceAfterSales</text>
          break;
              default:
    <text>成交时间：@order.ConfirmTime</text>
          break;
          }
          break;
            case 4:
    <text>取消订单时间：@order.ConfirmTime</text>
            break;
            case 5:
    <text>取消订单时间：@order.ConfirmTime</text>
            break;
            case 6:
    <text>交易失败时间：@order.ConfirmTime</text>
            break;
            case 7:
    <text>交易失败时间：@order.ConfirmTime</text>
            break;
            case 8:
    <text>申请退款时间：@order.RefundTime</text>
            break;
            case 9:
    <text>申请退款时间：@order.RefundTime</text>
            break;
            case 10:
    <text>达成协议时间：@order.AgreementTime</text>
            break;
            case 11:
    <text>付款时间：@order.PaymentTime</text>
          break;
            case 12:
    <text>达成协议时间：@order.ConfirmTime</text>
            break;
            case 13:
    <text>出库时间：@order.ShipmentsTime</text>
          break;
            default:
          break;
        }
}
<input type="hidden" id="rowcounts" value="@ViewBag.Count"/>
<table class="dgl_bot" style="color: #8C94A9; table-layout: fixed; word-break: break-all;
    width: 100%">
    <thead>
        <tr class="t_tr1" style="color: #8C94A9;">
            <td width="5px">
            </td>
            <td width="26%">
                <span style="float: left; margin-left: 6px;">
                    <input type="checkbox" id="allCheck" />
                    <span style="margin-left: 38px">全选</span> </span><span style="margin-left: 26px">商品名称
                    </span>
            </td>
            <td width="10%">
                <span style="margin-left: 20px;">单价（元）</span>
            </td>
            <td width="90px">
                数量
            </td>
            <td width="90px">
            </td>
            <td width="10%">
                买家
            </td>
            <td width="9%">
                交易状态<input type="hidden" id="states" value='' />
            </td>
            <td width="12%">
                实收款（元）<input type="hidden" id="prices" value='' />
            </td>
            <td width="12%">
                佣金支出（元）<input type="hidden" id="pricesOutput" value='' />
            </td>
            <td width="80px">
                收款方
            </td>
            <td width="80px">
                订单来源
            </td>
            <td width="80px">
                打印发货单
            </td>
            <td width="80px">
                打印快递单
            </td>
            <td width="80px">
                录入SN
            </td>
            <td width="110px;">
                备注
            </td>
            <td width="5">
            </td>
        </tr>
        <tr class="sep-row">
            <td colspan="13">
            </td>
        </tr>
    </thead>
    <tbody>
        @{
            int num = 0;
        }
        @foreach (Jinher.AMP.BTP.Deploy.CustomDTO.CommodityOrderVM commodityOrderVM in commodityOrderList)
        {
            var orderState = commodityOrderVM.CommodityOrderId + "_State";
            string stDisplay = commodityOrderVM.SelfTakeFlag == 0 ? "none" : "inline-block";
            <tr class="dgl_bot_header">
                <td class="left_sep">
                </td>
                <td colspan="14">
                    <input style="margin:5px;" type="checkbox" name="itemCheckBox" id ="@commodityOrderVM.CommodityOrderId"/>
                    <span class="ml15 addColor">订单编号：<a id="tzinfor" href="javascript:void(0)" target="_self" tzinfors="@string.Format("/CommodityOrder/CommodityOrderDetail?commodityOrderId={0}&isShowChangeExp={1}", commodityOrderVM.CommodityOrderId, isShowChangeExp)">@commodityOrderVM.CommodityOrderCode</a></span>
                    <span class="ml50 addColor">@getTimeState(commodityOrderVM)</span> <span class="ml20 addColor"  style="width: 38%;text-overflow: ellipsis;overflow: hidden;white-space: nowrap;vertical-align: middle;display:@stDisplay">
                        <img style="position: relative; top: 5px;" src="/Content/Images/ztflag.png" />
                        <span class="selftakeaddress" style="margin-top: -10;">@commodityOrderVM.SelfTakeAddress</span>
                    </span><span style=" float:right; margin-right:8px;cursor:pointer;" class="addColor"  onclick="ContactCustomer('@commodityOrderVM.CommodityOrderId','@commodityOrderVM.AppId','@commodityOrderVM.UserId')">
                        <img style="margin-top: 1px; margin-right: 5px;" src="/Images/contactCustomer.png" />联系客户</span>
                </td>
                <td class="right_sep">
                </td>
            </tr>

            if (commodityOrderVM.OrderItems != null && commodityOrderVM.OrderItems.Count > 0)
            {
                var count = commodityOrderVM.OrderItems.Count;
                var orderItems = commodityOrderVM.OrderItems;
                string isST = commodityOrderVM.SelfTakeFlag == 1 ? "block" : "none";

                for (var i = 0; i < count; i++)
                {
                    Jinher.AMP.BTP.Deploy.CustomDTO.OrderItemsVM orderItem = orderItems[i];
                    
            <tr class="dgl_bot_con">
                <td class="left_sep">
                </td>
                <td colspan="4">
                    <table style="width: 100%; padding-right: 20px;">
                        <tr>
                            <td align="left" style="border-bottom: none">
                                <table class="ghost">
                                    <tbody>
                                        <tr>
                                            <td>
                                                <div class="com_img ml15">
                                                    <div style="position: relative; width: 81px; height: 83px">
                                                        <img class="img" src="@orderItem.PicturesPath" width="81" height="83" />
                                                        <div class="selfTake" style="display:@isST">
                                                            <img class="selfTakeImg" style="display: block; width: 81px;" src="/Images/selftake.png"
                                                                alt="自提" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="com_info">
                                                    <div class="com_name" style="font-size: 12px; vertical-align: top">
                                                        @orderItem.CommodityIdName
                                                    </div>
                                                    <div class="com_cat_name">
                                                        @if (!string.IsNullOrEmpty(orderItem.ComCategoryName))
                                                        {
                                                            @orderItem.ComCategoryName
                                                        }
                                                    </div>
                                                    <div class="com_attr">
                                                        @foreach (var item in orderItem.CommodityCategorys)
                                                        {
                                                            if (item != "null" && item != "请选择")
                                                            {
                                                            <span style="padding-right: 5px;">@item</span>
                                                            }
                                                        }
                                                        @{
                                                        if (!string.IsNullOrEmpty(orderItem.SizeAndColorId))
                                                        {
                                                            orderItem.SizeAndColorId = orderItem.SizeAndColorId.Replace("颜色", "");
                                                            orderItem.SizeAndColorId = orderItem.SizeAndColorId.Replace("尺寸", "");
                                                            orderItem.SizeAndColorId = orderItem.SizeAndColorId.Replace(":", "");
                                                            orderItem.SizeAndColorId = orderItem.SizeAndColorId.Replace("：", "");
                                                            List<string> attrs = orderItem.SizeAndColorId.Split(new char[] { ',', '，' }, StringSplitOptions.RemoveEmptyEntries).ToList();
                                                            foreach (string attr in attrs)
                                                            {
                                                                if (attr != "null" && attr != "请选择")
                                                                {
                                                            <span style="padding-right: 5PX;">@attr</span>
                                                                }
                                                            }
                                                        }
                                                    
                                                        }
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </td>
                            <td align="center" class="com_price" style="border-bottom: none">
                                <p>
                                    @Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@orderItem.Price
                                </p>
                                @if (i == count - 1 && commodityOrderVM.SetMealId != Guid.Empty)
                                {
                                    decimal tolPrice = 0;
                                    for (var j = 0; j < count; j++)
                                    {
                                        tolPrice += orderItems[j].Price * orderItems[j].Number;
                                    }
                                    <br />
                                    <br />
                                    <p>
                                        套餐价：@Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@tolPrice</p>
                                }
                            </td>
                            <td align="center" style="border-bottom: none">
                                <div>@orderItem.Number</div>
                            </td>
                            <!--订单项状态为退款中-->
                            @if (orderItem.State == 1)
                            {
                                <td align="center" style="border-bottom: none">
                                    <div>
                                        <text>
                                            <div class="ghcred"> 客户申请退款</div></text>
                                        <br />
                                        <text>
                                            <div> <a href="javascript:void(0);" id="refundInforOrderItem" retype="" orpayment="@commodityOrderVM.Payment"
                                                     orderid="@commodityOrderVM.CommodityOrderId" orstate="21"
                                                     orAfState="@commodityOrderVM.StateAfterSales" selfTakeFlag="@commodityOrderVM.SelfTakeFlag"
                                                     orStateRefundAfterSales="@commodityOrderVM.StateRefundAfterSales" orStateRefund="@commodityOrderVM.StateRefund" orderItemid="@orderItem.Id">
                                                    查看详情</a>
                                            </div></text>
                                    </div>
                                </td>
                            }
                            else if (orderItem.State == 2)
                            {
                                <td align="center" style="border-bottom: none">
                                    <div>
                                        <text>
                                            <div class="ghcred">已退款</div></text>
                                    </div>
                                    @if (orderItem.RefundOrderItemId != Guid.Empty && orderItem.RefundOrderItemId != null)
                                    {
                                        if (orderItem.StateRefund > 0 || orderItem.StateAfterSales > 0)
                                        {
                                            <text>
                                                <div> <a href="javascript:void(0);" id="refundInforOrderItem" retype="" orpayment="@commodityOrderVM.Payment"
                                                            orderid="@commodityOrderVM.CommodityOrderId" orderitemid="@orderItem.Id" orstate="@commodityOrderVM.State"
                                                            orAfState="@commodityOrderVM.StateAfterSales" selfTakeFlag="@commodityOrderVM.SelfTakeFlag"
                                                            orStateRefundAfterSales="@commodityOrderVM.StateRefundAfterSales" orStateRefund="@commodityOrderVM.StateRefund">
                                                        查看详情</a>
                                                </div></text>
                                        }
                                    }
                                </td>
                            }
                            else if (orderItem.State == 3)
                            {
                                <td align="center" style="border-bottom: none">
                                    <div>
                                        <text>
                                            <div class="ghcred"> 已达成协议 </div>
                                        </text>
                                        @if (orderItem.RefundExpCo != null && orderItem.RefundExpOrderNo != null)
                                        {
                                            <text>
                                            <div>
                                                <a href="javascript:;" id="refundItemexp" orpayment="@commodityOrderVM.Payment"
                                                     orderid="@commodityOrderVM.CommodityOrderId" orstate="@commodityOrderVM.State" orAfState="@commodityOrderVM.StateAfterSales" orderItemid="@orderItem.Id">
                                                    退货物流信息</a>
                                            </div></text>
                                        }
                                        @if (orderItem.RefundOrderItemId != Guid.Empty && orderItem.RefundOrderItemId != null)
                                        {
                                            if (orderItem.StateRefund > 0 || orderItem.StateAfterSales > 0)
                                            {
                                                <text>
                                                    <div> <a href="javascript:void(0);" id="refundInforOrderItem" retype="" orpayment="@commodityOrderVM.Payment"
                                                                orderid="@commodityOrderVM.CommodityOrderId" orderitemid="@orderItem.Id" orstate="@commodityOrderVM.State"
                                                                orAfState="@commodityOrderVM.StateAfterSales" selfTakeFlag="@commodityOrderVM.SelfTakeFlag"
                                                                orStateRefundAfterSales="@commodityOrderVM.StateRefundAfterSales" orStateRefund="@commodityOrderVM.StateRefund">
                                                            查看详情</a>
                                                    </div></text>
                                            }
                                        }
                                    </div>
                                </td>
                            }
                            else
                            {
                                <td align="center" rowspan="@count" style="border-bottom: none">
                                    @switch (commodityOrderVM.State)
                                    {
                                        case 0:
                                        <text><span>待付款</span>
                                        </text>
                                            break;
                                        case 1:
                                        <text><span>待发货</span>
                                        </text>
                                            if (orderItem.RefundOrderItemId != Guid.Empty && orderItem.RefundOrderItemId != null)
                                            {
                                                if (orderItem.StateRefund == 2)
                                                {
                                                    if (orderItem.RefundType == 0)
                                                    {
                                                        <text><div class="ghcred"> 已拒绝退款申请</div></text>
                                                    }
                                                    if (orderItem.RefundType == 1)
                                                    {
                                                        <text>
                                                            <div class="ghcred"> 已拒绝退款/退货申请</div></text>
                                                    }
                                                    if (orderItem.StateRefund > 0 || orderItem.StateAfterSales > 0)
                                                    {
                                                        <text>
                                                            <div> <a href="javascript:void(0);" id="refundInforOrderItem" retype="" orpayment="@commodityOrderVM.Payment"
                                                                     orderid="@commodityOrderVM.CommodityOrderId" orderitemid="@orderItem.Id" orstate="@commodityOrderVM.State"
                                                                     orAfState="@commodityOrderVM.StateAfterSales" selfTakeFlag="@commodityOrderVM.SelfTakeFlag"
                                                                     orStateRefundAfterSales="@commodityOrderVM.StateRefundAfterSales" orStateRefund="@commodityOrderVM.StateRefund">
                                                                    查看详情</a>
                                                            </div></text>
                                                    }
                                                }
                                                else if (orderItem.StateRefund == 4)
                                                {
                                                    <text>
                                                        <div class="ghcred"> 已拒绝收货</div></text>
                                                    if (orderItem.StateRefund > 0 || orderItem.StateAfterSales > 0)
                                                    {
                                                        <text>
                                                            <div> <a href="javascript:void(0);" id="refundInforOrderItem" retype="" orpayment="@commodityOrderVM.Payment"
                                                                     orderid="@commodityOrderVM.CommodityOrderId" orderitemid="@orderItem.Id" orstate="@commodityOrderVM.State"
                                                                     orAfState="@commodityOrderVM.StateAfterSales" selfTakeFlag="@commodityOrderVM.SelfTakeFlag"
                                                                     orStateRefundAfterSales="@commodityOrderVM.StateRefundAfterSales" orStateRefund="@commodityOrderVM.StateRefund">
                                                                    查看详情</a>
                                                            </div></text>
                                                    }
                                                }
                                            }
                                            break;
                                        case 2:
                                            //货到付款
                                        <text><span>已发货</span>
                                        </text>
                                            if (orderItem.RefundOrderItemId != Guid.Empty && orderItem.RefundOrderItemId != null)
                                            {
                                                if (orderItem.StateRefund == 2)
                                                {
                                                    if (orderItem.RefundType == 0)
                                                    {
                                                        <text><div class="ghcred"> 已拒绝退款申请</div></text>
                                                    }
                                                    if (orderItem.RefundType == 1)
                                                    {
                                                        <text>
                                                            <div class="ghcred"> 已拒绝退款/退货申请</div></text>
                                                    }
                                                    if (orderItem.StateRefund > 0 || orderItem.StateAfterSales > 0)
                                                    {
                                                        <text>
                                                            <div> <a href="javascript:void(0);" id="refundInforOrderItem" retype="" orpayment="@commodityOrderVM.Payment"
                                                                     orderid="@commodityOrderVM.CommodityOrderId" orderitemid="@orderItem.Id" orstate="@commodityOrderVM.State"
                                                                     orAfState="@commodityOrderVM.StateAfterSales" selfTakeFlag="@commodityOrderVM.SelfTakeFlag"
                                                                     orStateRefundAfterSales="@commodityOrderVM.StateRefundAfterSales" orStateRefund="@commodityOrderVM.StateRefund">
                                                                    查看详情</a>
                                                            </div></text>
                                                    }
                                                }
                                                else if (orderItem.StateRefund == 4)
                                                {
                                                    <text>
                                                        <div class="ghcred"> 已拒绝收货</div></text>
                                                    if (orderItem.StateRefund > 0 || orderItem.StateAfterSales > 0)
                                                    {
                                                        <text>
                                                            <div> <a href="javascript:void(0);" id="refundInforOrderItem" retype="" orpayment="@commodityOrderVM.Payment"
                                                                     orderid="@commodityOrderVM.CommodityOrderId" orderitemid="@orderItem.Id" orstate="@commodityOrderVM.State"
                                                                     orAfState="@commodityOrderVM.StateAfterSales" selfTakeFlag="@commodityOrderVM.SelfTakeFlag"
                                                                     orStateRefundAfterSales="@commodityOrderVM.StateRefundAfterSales" orStateRefund="@commodityOrderVM.StateRefund">
                                                                    查看详情</a>
                                                            </div></text>
                                                    }
                                                }
                                            }
                                            break;
                                        case 3:
                                            switch (commodityOrderVM.StateAfterSales)
                                            {
                                                case -1:
                                                    if (orderItem.JdState == 3)
                                                    { 
                                                        <text>已拒收</text>
                                                    }
                                                    else
                                                    {                                                        
                                                        <text>交易成功</text>
                                                    }
                                                    break;
                                                case 3:
                                                    if (orderItem.JdState == 3)
                                                    { 
                                                        <text>已拒收</text>
                                                    }
                                                    else
                                                    {                                                        
                                                        <text>交易成功</text>
                                                    }
                                                    if (!directArrivalPayments.Contains(commodityOrderVM.Payment))
                                                    {
                                        <div style="color: red;">
                                            (冻结)</div>
                                                    }
                                                    if (orderItem.RefundOrderItemId != Guid.Empty && orderItem.RefundOrderItemId != null)
                                                    {
                                                        if (orderItem.StateAfterSales == 2)
                                                        {
                                                            if (orderItem.RefundType == 0)
                                                            {
                                                                <text><div class="ghcred"> 已拒绝退款申请</div></text>
                                                            }
                                                            if (orderItem.RefundType == 1)
                                                            {
                                                                <text>
                                                                    <div class="ghcred"> 已拒绝退款/退货申请</div></text>
                                                            }
                                                            if (orderItem.StateRefund > 0 || orderItem.StateAfterSales > 0)
                                                            {
                                                                <text>
                                                                    <div> <a href="javascript:void(0);" id="refundInforOrderItem" retype="" orpayment="@commodityOrderVM.Payment"
                                                                             orderid="@commodityOrderVM.CommodityOrderId" orderitemid="@orderItem.Id" orstate="@commodityOrderVM.State"
                                                                             orAfState="@commodityOrderVM.StateAfterSales" selfTakeFlag="@commodityOrderVM.SelfTakeFlag"
                                                                             orStateRefundAfterSales="@commodityOrderVM.StateRefundAfterSales" orStateRefund="@commodityOrderVM.StateRefund">
                                                                            查看详情</a>
                                                                    </div></text>
                                                            }
                                                        }
                                                        else if (orderItem.StateAfterSales == 4)
                                                        {
                                                            <text>
                                                                <div class="ghcred"> 已拒绝收货</div></text>
                                                            if (orderItem.StateRefund > 0 || orderItem.StateAfterSales > 0)
                                                            {
                                                            <text>
                                                                <div> <a href="javascript:void(0);" id="refundInforOrderItem" retype="" orpayment="@commodityOrderVM.Payment"
                                                                         orderid="@commodityOrderVM.CommodityOrderId" orderitemid="@orderItem.Id" orstate="@commodityOrderVM.State"
                                                                         orAfState="@commodityOrderVM.StateAfterSales" selfTakeFlag="@commodityOrderVM.SelfTakeFlag"
                                                                         orStateRefundAfterSales="@commodityOrderVM.StateRefundAfterSales" orStateRefund="@commodityOrderVM.StateRefund">
                                                                        查看详情</a>
                                                                </div></text>
                                                            }
                                                        }
                                                    }
                                                    break;
                                                case 15:
                                        <text>交易成功</text>
                                                    break;
                                                case 5:
                                                case 10:

                                        <text>退款中</text>
                                                    break;
                                                case 12:
                                        <text>处理退款中</text>
                                                    break;
                                                case 7:
                                        <text>已退款</text>
                                                    break;
                                                default:
                                        <text>交易成功</text>
                                                    break;
                                            }
                                            break;
                                        case 4:
                                        <text>交易失败</text>
                                            break;
                                        case 6:
                                        <text>交易失败</text>
                                            break;
                                        case 8:
                                        case 14:

                                        <text><span>退款中</span>
                                        </text>
                                            break;
                                        case 9:
                                        <text>退款中</text>
                                            break;
                                        case 7:
                                        <text>已退款</text>
                                            break;
                                        case 10:
                                        <text>退款中</text>
                                            break;
                                        case 5:
                                        <text>交易失败</text>
                                            break;
                                        case 11:
                                        <text><span>待发货</span>
                                        </text>
                                            break;
                                        case 12:
                                        <text>处理退款中</text>
                                            break;
                                        case 13:
                                        <text>出库中
                                        </text>
                                            break;

                                    }
                                </td>
                            }
                        </tr>
                        @if (orderItem.Presents != null)
                        {
                            foreach (var p in orderItem.Presents)
                            {
                            <tr>
                                <td align="left" style="border-bottom: none">
                                    <table class="ghost">
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div class="com_img ml15">
                                                        <div style="position: relative; width: 81px; height: 83px">
                                                            <img class="img" src="@p.PicturesPath" width="81" height="83" />
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="com_info">
                                                        <div class="com_name" style="font-size: 12px; vertical-align: top">
                                                            【赠品】@p.CommodityName
                                                        </div>
                                                        <div class="com_cat_name">
                                                            @if (!string.IsNullOrEmpty(p.ComCategoryName))
                                                            {
                                                                @p.ComCategoryName
                                                            }
                                                        </div>
                                                        <div class="com_attr">
                                                            @{
                                                            if (!string.IsNullOrEmpty(p.SizeAndColorId))
                                                            {
                                                                p.SizeAndColorId = p.SizeAndColorId.Replace("颜色", "");
                                                                p.SizeAndColorId = p.SizeAndColorId.Replace("尺寸", "");
                                                                p.SizeAndColorId = p.SizeAndColorId.Replace(":", "");
                                                                p.SizeAndColorId = p.SizeAndColorId.Replace("：", "");
                                                                List<string> attrs = p.SizeAndColorId.Split(new char[] { ',', '，' }, StringSplitOptions.RemoveEmptyEntries).ToList();
                                                                foreach (string attr in attrs)
                                                                {
                                                                    if (attr != "null" && attr != "请选择")
                                                                    {
                                                                <span style="padding-right: 5PX;">@attr</span>
                                                                    }
                                                                }
                                                            }                                                    
                                                            }
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                                <td align="center" class="com_price" style="border-bottom: none">
                                    <p>
                                        @Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@p.RealPrice
                                    </p>
                                </td>
                                <td align="center" style="border-bottom: none">
                                    <div>@p.Number</div>
                                </td>
                            </tr>
                            }
                        }
                    </table>
                </td>
                @if (i == 0)
                {
                    <td align="center" rowspan="@count" class="left_border">@commodityOrderVM.ReceiptUserName
                    </td> 
                    <td align="center"  rowspan="@count"  class="left_border">
                        <p style="vertical-align: middle">
                            @switch (commodityOrderVM.State)
                            {
                                case 0:
                                <text><span>待付款</span>
                                <br />
                                <a href="javascript:;" class="state">修改</a> <span style="display: none;">
                                    <select class="select">
                                        <option value="0">请选择</option>
                                        <option value="4">取消订单</option>
                                    </select><br />
                                    <a href="javascript:;" class="updates"  onclick="Updates(this,'@commodityOrderVM.CommodityOrderId')">
                                        确定</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:;" class="cancel">取消</a></span>
                                @* 待付款时不能进行修改（以后可能会改，不要删除注释部分代码！）
                                                    <br/><a href="javascript:;" class="state">修改</a>
                                                    <span style="display:none;"><select class="select"><option value="2">已发货</option>
                                                    <option value="4">取消订单</option>
                                                </select><br /><a href="javascript:;" class="updates" onclick="Updates(this,'@commodityOrderVM.CommodityOrderId')">
                                                    确定</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:;" class="cancel">取消</a></span>*@
                                </text>
                                                                                              break;
                                case 1:
                                <text><span>待发货</span><br />
                                @if (((ViewBag.IsOrg == null) || (ViewBag.IsOrg != null && ViewBag.BTPOrderStateUpd != null && ViewBag.IsOrg && ViewBag.BTPOrderStateUpd)) 
                                    && _objstr.Contains("出库"))
                                {
                                    if (commodityOrderVM.OrderType == 3)
                                    {
                                        <a href="javascript:;" class="state" style="display:none">修改</a>  
                                    } 
                                    else
                                    {
                                        <a href="javascript:;" class="state" style="display:inline">修改</a>                                         
                                    }
                                }
                                <span style="display: none;" class="CaoZuo">
                                    <select id="selectSecond" class="select" onchange="SecondSelectChange(this,'@commodityOrderVM.CommodityOrderId')">
                                        <option value="13">出库中</option>
                                        @*<option value="2">已发货</option>*@
                                        @if (commodityOrderVM.Payment == 1)
                                        {
                                            <option value="4">取消订单</option>
                                        }
                                    </select><br />

                                    @if (_objstr.Contains("出库"))
                                    {
                                        <a href="javascript:;" class="updates btn"  onclick="Updates(this,'@commodityOrderVM.CommodityOrderId')" >确定</a><a style="margin-left:3px;" href="javascript:;" class="cancel btn">取消</a>
                                    }
                                    else{
                                        <span class="btn">确定</span><span style="margin-left:3px;" class="btn">取消</span>
                                    }
                                    
                                </span>
                                </text>
                                    break;
                                case 2:
                                    if (commodityOrderVM.Payment == 1)
                                    {//货到付款
                                <text><span>已发货</span><br />
                                @if ((ViewBag.IsOrg == null) || (ViewBag.IsOrg != null && ViewBag.BTPOrderStateUpd != null && ViewBag.IsOrg && ViewBag.BTPOrderStateUpd))
                                {
                                    <a href="javascript:;" class="state">修改</a>
                                }
                                <span style="display: none;">
                                    <select class="select">
                                        <option value="3">交易成功</option>
                                        <option value="4">取消订单</option>
                                    </select><br />
                                    <a href="javascript:;" class="updates"  onclick="Updates(this,'@commodityOrderVM.CommodityOrderId')">
                                        确定</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:;" class="cancel">取消</a>
                                </span>
                                </text>
                                    }
                                    else
                                    {
                                <text>已发货</text>
                                    };
                                    break;
                                case 3:
                                    switch (commodityOrderVM.StateAfterSales)
                                    {
                                        case -1:
                                <text>交易成功</text>                                                     break; break;
                                        case 3:
                                <text>交易成功</text>
                                            if (!directArrivalPayments.Contains(commodityOrderVM.Payment))
                                            {
                                <div style="color: red;">
                                    (冻结)</div>   
                                            }
                                            break;
                                        case 15:
                                <text>交易成功</text>
                                            break;
                                        case 5:
                                        case 10:

                                <text>退款中</text>
                                            break;
                                        case 12:
                                <text>处理退款中</text>
                                            break;
                                        case 7:
                                <text>已退款</text>
                                            break;
                                        default:                                             
                                <text>交易成功</text>
                                            break;
                                    }
                                    break;
                                case 4:
                                <text>交易失败</text>
                                    break;
                                case 6:
                                <text>交易失败</text>                                                       
                                    break;
                                case 8:
                                case 14:
                                                
                                <text><span>退款中</span><br />
                                @if (((ViewBag.IsOrg == null) || (ViewBag.IsOrg != null && ViewBag.BTPOrderStateUpd != null && ViewBag.IsOrg && ViewBag.BTPOrderStateUpd))
                                    && _objstr.Contains("发货")
                                    )
                                {
                                    <a href="javascript:;" class="state">修改</a> 
                                }
                                <span style="display: none;">
                                    <select class="select">
                                        <option value="2">已发货</option>
                                    </select><br />
                                    @if (_objstr.Contains("发货"))
                                    {
                                        <a href="javascript:;" class="updates"  onclick="Updates(this,'@commodityOrderVM.CommodityOrderId')">
                                        确定</a>@Html.Raw("&nbsp;&nbsp;&nbsp;&nbsp;")<a href="javascript:;" class="cancel">取消</a>
                                    }
                                    else
                                    {
                                        <span class="btn">确定</span><span style="margin-left:3px;" class="btn">取消</span>
                                    }
                                    
                                </span>
                                </text>
                                    break;
                                case 9:
                                <text>退款中</text>
                                    break;
                                case 7:
                                <text>已退款</text>
                                    break;
                                case 10:
                                <text>退款中</text>
                                    break;
                                case 5:
                                <text>交易失败</text>
                                    break;
                                case 11:
                                <text><span>待发货</span><br />
                                @if ((ViewBag.IsOrg == null) || (ViewBag.IsOrg != null && ViewBag.BTPOrderStateUpd != null && ViewBag.IsOrg && ViewBag.BTPOrderStateUpd))
                                {
                                    <a href="javascript:;" class="state">修改</a> 
                                }
                                <span style="display: none;" class="CaoZuo">
                                    <select id="SelectFirst" class="select" onchange="FirstSelectChange(this,'@commodityOrderVM.CommodityOrderId')">
                                        <option value="13">出库中</option>
                                        @*<option value="11">已发货</option>*@
                                        @if (commodityOrderVM.Payment == 1)
                                        {
                                            <option value="4">取消订单</option>
                                        }
                                    </select><br />
                                    @if (_objstr.Contains("出库"))
                                    {
                                        <a href="javascript:;" class="updates btn"  onclick="Updates(this,'@commodityOrderVM.CommodityOrderId')" >确定</a><a style="margin-left:3px;" href="javascript:;" class="cancel btn">取消</a>
                                    }
                                    else{
                                        <span class="btn">确定</span><span style="margin-left:3px;" class="btn">取消</span>
                                    }
                                    
                                </text>
                                    break;
                                case 12:
                                <text>处理退款中</text>
                                    break;
                                case 13:
                                <text>出库中
                                <br />
                                @if ((ViewBag.IsOrg == null) || (ViewBag.IsOrg != null && ViewBag.BTPOrderStateUpd != null && ViewBag.IsOrg && ViewBag.BTPOrderStateUpd 
                                    && (_objstr.Contains("发货") || commodityOrderVM.Payment == 1)))
                                {
                                    <a href="javascript:;" class="state">修改</a> 
                                }
                                <span style="display: none;">
                                    <select class="select">
                                        <option value="2">已发货</option>
                                        @if (commodityOrderVM.Payment == 1)
                                        {
                                            <option value="4">取消订单</option>
                                        }
                                    </select><br />
                                    @if (_objstr.Contains("发货"))
                                    {
                                        <a href="javascript:;" class="updates"  onclick="Updates(this,'@commodityOrderVM.CommodityOrderId')">
                                        确定</a>@Html.Raw("&nbsp;&nbsp;&nbsp;&nbsp;")<a href="javascript:;" class="cancel">取消</a>
                                    }

                                    else
                                    {
                                        <span  class="btn">确定</span><span style="margin-left:3px;" class="btn">取消</span>
                                    }
                                </span>
                                </text>
                                    break;

                            }
                        </p>
                    </td>
                    <td align="center" rowspan="@count" class="left_border">
                        <div class="parentElement">
                            <input class="hiddprice" type="hidden" value="@(commodityOrderVM.Price + commodityOrderVM.Freight)" />
                            @if (commodityOrderVM.GoldPrice > decimal.Zero && commodityOrderVM.Payment != 0)
                            {
                                <text><div>
                                    @Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@commodityOrderVM.GoldPrice (金币)</div></text>
                            }
                            @if (commodityOrderVM.GoldCoupon > decimal.Zero)
                            {
                                <text><div>
                                    @Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@commodityOrderVM.GoldCoupon (代金券)</div></text>
                            }
                            @if (commodityOrderVM.CouponValue > decimal.Zero)
                            {
                                <text><div>
                                    @Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@commodityOrderVM.CouponValue (优惠券)</div></text>
                            }
                            @if (commodityOrderVM.SpendScoreMoney > decimal.Zero)
                            {
                                <text><div>
                                    @Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@commodityOrderVM.SpendScoreMoney (积分抵现)</div></text>
                            }
                            @if (commodityOrderVM.SpendYJBMoney > decimal.Zero)
                            {
                                <text><div>
                                    @Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@commodityOrderVM.SpendYJBMoney (易捷币抵现)</div></text>
                            }
                            @if (commodityOrderVM.State == 0)
                            {
                                if (commodityOrderVM.IsModifiedPrice == true)
                                {
                                <text> <font class="yprice" style="text-decoration: line-through;">@Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@(commodityOrderVM.Price + commodityOrderVM.Freight)
                                </font>
                                <br />
                                </text>
                                }
                                <text> <span class="find_1">@Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@commodityOrderVM.CurrentPrice</span>
                                @if (commodityOrderVM.IsModifiedPrice == true)
                                {
                                <img src="/Content/images/update.png" alt="" width="17" height="17" />
                                }
                                <br />
                                @if ((ViewBag.IsOrg == null) || (ViewBag.IsOrg != null && ViewBag.IsOrg 
                                    && objstr.Contains("订单价格修改")))
                                {
                                    <a href="javascript:;" class="state">修改</a> 
                                }
                                <span style="display: none;">
                                    <input class="price" type="text" style="width:50px;border:1px solid #B8BFCF;" value="@commodityOrderVM.CurrentPrice" />
                                    <br />
                                    <a href="javascript:;"  onclick="UpdatePrice(this,'@commodityOrderVM.CommodityOrderId')">
                                        确定</a> &nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:;" class="cancel" onclick="CancelUpdatePrice(this)">取消</a></span>
                                </text>
                            }
                            else
                            {
                                if (commodityOrderVM.State != 4 && commodityOrderVM.State != 5)
                                {
                                <text> <span class="find_1">@Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@(commodityOrderVM.Payment == 0 ? commodityOrderVM.GoldPrice : (commodityOrderVM.CurrentPrice - commodityOrderVM.GoldPrice - commodityOrderVM.GoldCoupon))(@Jinher.AMP.BTP.UI.Models.PaySourceVM.GetPaymentName(commodityOrderVM.Payment))</span>
                                <br />
                                </text> 

                                    if (commodityOrderVM.IsModifiedPrice == true)
                                    {                                                    
                                <text> <font class="yprice" style="text-decoration: line-through;">@Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@(commodityOrderVM.Price + commodityOrderVM.Freight)
                                </font>
                                @if (commodityOrderVM.IsModifiedPrice == true)
                                {
                                <img src="/Content/images/update.png" alt="" width="17" height="17" />
                                }
                                <span class="find_1">@Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@commodityOrderVM.CurrentPrice
                                <br />
                                </text>
                                    }
                               
                                <text></text>
                                }
                                else
                                {
                                <text> <span class="find_1">@Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@(commodityOrderVM.Payment == 0 ? commodityOrderVM.GoldPrice : (commodityOrderVM.CurrentPrice - commodityOrderVM.GoldPrice - commodityOrderVM.GoldCoupon))(@Jinher.AMP.BTP.UI.Models.PaySourceVM.GetPaymentName(commodityOrderVM.Payment))</span>
                                <br />
                                </text> 

                                    if (commodityOrderVM.IsModifiedPrice == true)
                                    {                                                    
                                <text> <font class="yprice" style="text-decoration: line-through;">@Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@(commodityOrderVM.Price + commodityOrderVM.Freight)
                                </font>
                                @if (commodityOrderVM.IsModifiedPrice == true)
                                {
                                <img src="/Content/images/update.png" alt="" width="17" height="17" />
                                }
                                <span class="find_1">@Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@commodityOrderVM.CurrentPrice
                                <br />
                                </text>
                                    }                                            
                                <text></text>                                               
                                <br />
                                    if (commodityOrderVM.MessageToBuyer != null)
                                    {
                                        if (commodityOrderVM.MessageToBuyer.Length > 30)
                                        {
                                            var str = 15;
                                            var commo = commodityOrderVM.MessageToBuyer;
                                            var fcount = commodityOrderVM.MessageToBuyer.Length / 15;
                                            for (var y = 0; y < fcount; y++)
                                            {
                                                commo = commo.Insert(str, "\n");
                                                str = str + 16;

                                            }
                                <text><span title="@commo">(@commodityOrderVM.MessageToBuyer.Substring(0, 30)
                                </span>...)
                                </text>
                                        }
                                        else
                                        {
                                <text>(@commodityOrderVM.MessageToBuyer)</text>
                                        }
                                    }
                                }
                            }
                            @if (commodityOrderVM.State == 8 || commodityOrderVM.State == 9 || commodityOrderVM.State == 7 || commodityOrderVM.State == 14)
                            {
                                if (commodityOrderVM.State == 8)
                                {
                                <text><div class="ghcred"> 客户申请退款</div></text>
                                }
                                else if (commodityOrderVM.State == 9 || commodityOrderVM.State == 14)
                                {
                                <text><div class="ghcred"> 客户申请退款/退货</div></text>
                                }
                                else if (commodityOrderVM.State == 7)
                                {

                                }
                            }
                            else if (commodityOrderVM.State == 1 || commodityOrderVM.State == 2 || commodityOrderVM.State == 13)
                            {
                                if (commodityOrderVM.StateRefund == 2)
                                {
                                    if (commodityOrderVM.RefundType == 0)
                                    {
                                <text><div class="ghcred"> 已拒绝退款申请</div></text>
                                    }
                                    if (commodityOrderVM.RefundType == 1)
                                    {
                                <text><div class="ghcred"> 已拒绝退款/退货申请</div></text>
                                    }
                                }
                                else if (commodityOrderVM.StateRefund == 4)
                                {
                                <text><div class="ghcred"> 已拒绝收货</div></text>
                                }
                            }
                            else
                            {
                                if (commodityOrderVM.State == 10)
                                {
                                <text><div class="ghcred"> 已达成协议 </div>
                                </text> 
                                    if (commodityOrderVM.RefundExpCo != null && commodityOrderVM.RefundExpOrderNo != "")
                                    {
                                <text><div> <a href="javascript:;" id="refundexp" orpayment="@commodityOrderVM.Payment"
                                orderid="@commodityOrderVM.CommodityOrderId" orstate= "@commodityOrderVM.State">
                                退货物流信息</a></div></text>
                                    }
                                }

                            }
                            @if (commodityOrderVM.State == 2)
                            {
                                if (commodityOrderVM.IsDelayConfirmTime)
                                {
                                <text><div class="ghcred"> 买家申请延长收货时间3天！</div></text>
                                }
                            }
                            @if (commodityOrderVM.State == 4 || commodityOrderVM.State == 5 || commodityOrderVM.State == 6 || commodityOrderVM.State == 7)
                            {
                                if (objstr.Contains("删除订单"))
                                {
                                    <text><div> <a href="javascript:;" id="delorder" orderid="@commodityOrderVM.CommodityOrderId">删除</a></div></text>
                                }
                            }
                            else if (commodityOrderVM.State == 3)
                            {
                                if (commodityOrderVM.StateAfterSales == 5 && commodityOrderVM.StateRefundAfterSales == 0)
                                {
                                    <text><div class="ghcred"> 客户申请退款/退货</div></text>
                                }
                                else if (commodityOrderVM.StateAfterSales == 3 && commodityOrderVM.StateRefundAfterSales == 13)
                                {
                                    <text>
                                        <div class="ghcred"> 超时，客户未发货</div></text>
                                }
                                else if (commodityOrderVM.StateAfterSales == 3 && commodityOrderVM.StateRefundAfterSales == 2)
                                {
                                    if (commodityOrderVM.RefundType == 0)
                                    {
                                        <text>
                                            <div class="ghcred"> 已拒绝退款申请</div></text>
                                    }
                                    if (commodityOrderVM.RefundType == 1)
                                    {
                                        <text>
                                            <div class="ghcred"> 已拒绝退款/退货申请</div></text>
                                    }
                                }
                                else if (commodityOrderVM.StateAfterSales == 3 && commodityOrderVM.StateRefundAfterSales == 4)
                                {
                                    <text>
                                        <div class="ghcred"> 已拒绝收货</div></text>
                                }
                                //售后退款中=5,已退款=7，商家未收到货=10 ,金和处理退款中=12
                                if (commodityOrderVM.StateAfterSales == 5)
                                {

                                }
                                else if (commodityOrderVM.StateAfterSales == 7)
                                {
                                    if (objstr.Contains("删除订单"))
                                    {
                                    <text><div> <a href="javascript:;" id="delorder" orderid="@commodityOrderVM.CommodityOrderId">删除</a></div>
                                    </text>
                                    }

                                }
                                else if (commodityOrderVM.StateAfterSales == 10)
                                {
                                <div class="ghcred"> 已达成协议 </div>
                                    if (commodityOrderVM.IsDelayConfirmTimeAfterSales == true && commodityOrderVM.StateRefundAfterSales == 11)
                                    {
                                <text><div class="ghcred"> 卖家申请延长收货时间3天！</div></text>
                                    }
                                    if (commodityOrderVM.RefundExpCo != null && commodityOrderVM.RefundExpOrderNo != "")
                                    {
                                <text><div> <a href="javascript:void(0);" id="refundexp" orpayment="@commodityOrderVM.Payment"
                                orderid="@commodityOrderVM.CommodityOrderId" orstate= "@commodityOrderVM.State"
                                orAfState="@commodityOrderVM.StateAfterSales" > 退货物流信息</a></div></text>
                                    }
                                    else
                                    {

                                    }
                                }

                            }
                            @if ((commodityOrderVM.StateRefund >= 0 || commodityOrderVM.StateRefundAfterSales >= 0) && commodityOrderVM.OrderItems.Count(t => t.State != 0) == 0)
                            {
                                <text><div> <a href="javascript:void(0);" id="refundInfor" retype="" orpayment="@commodityOrderVM.Payment"
                                orderid="@commodityOrderVM.CommodityOrderId" orstate= "@commodityOrderVM.State"
                                orAfState="@commodityOrderVM.StateAfterSales" selfTakeFlag="@commodityOrderVM.SelfTakeFlag"
                                orStateRefundAfterSales="@commodityOrderVM.StateRefundAfterSales" orStateRefund="@commodityOrderVM.StateRefund">
                                查看详情</a></div></text>
                            }
                            @{                                              
                            if (commodityOrderVM.IsModifiedPrice == false && commodityOrderVM.SelfTakeFlag == 0)
                            {
                                <text> <div class="spanFreight"> 含运费 @commodityOrderVM.Freight 元 </div></text>
                            }
                            }
                            @if (commodityOrderVM.State == 3 && commodityOrderVM.Commission > decimal.Zero)
                            {                                             
                                <text> <div> 支付众销佣金 @commodityOrderVM.Commission 元 </div></text>
                            }
                            @if (commodityOrderVM.IsCrowdfunding && commodityOrderVM.CfDividend.HasValue && commodityOrderVM.CfDividend.Value > decimal.Zero && commodityOrderVM.State != 0 && commodityOrderVM.State != 11)
                            {
                                decimal cfdividend = commodityOrderVM.CfDividend.HasValue ? commodityOrderVM.CfDividend.Value : 0.0m;
                                <text> <div> 支付众筹佣金 @string.Format("{0:0.00#}", cfdividend) 元 </div></text>
                            }
                            @if (commodityOrderVM.SpreadGold > decimal.Zero)
                            { 
                                <text> <div style="display: block;"> 推广者分成 @string.Format("{0:0.00#}", (decimal)commodityOrderVM.SpreadGold / 1000)
                                元 </div></text>
                            }
                            @if (commodityOrderVM.OwnerShare > decimal.Zero)
                            { 
                                <text> <div style="display: block;"> 应用主分成 @string.Format("{0:0.00#}", commodityOrderVM.OwnerShare)
                                元 </div></text>
                            }
                          @{
                            if (commodityOrderVM.State == 7)
                            {
                                if (commodityOrderVM.RefundScoreMoney > 0 && commodityOrderVM.RefundYJBMoney > 0)
                                {
                                      <text><div> 退款 @(commodityOrderVM.RefundMoney)元（含
                                              @commodityOrderVM.RefundScoreMoney 元积分；@commodityOrderVM.RefundYJBMoney 元易捷币）</div>
                                      </text>
                                }
                                else if (commodityOrderVM.RefundYJBMoney > 0)
                                {
                                      <text>
                                          <div> 退款 @(commodityOrderVM.RefundMoney)元（含
                                              @commodityOrderVM.RefundYJBMoney
                                              元易捷币）</div>
                                      </text>
                                }
                                else if (commodityOrderVM.RefundScoreMoney > 0)
                                {
                                      <text>
                                          <div> 退款 @(commodityOrderVM.RefundMoney)元（含
                                              @commodityOrderVM.RefundScoreMoney 元积分）</div>
                                      </text>
                                }
                                else
                                {
                                      <text>
                                          <div> 退款 @commodityOrderVM.RefundMoney 元</div></text>
                                }
                            }
                            else if (commodityOrderVM.State == 3 && commodityOrderVM.StateAfterSales == 7)
                            {
                                if (commodityOrderVM.SpendScoreMoney > 0 && commodityOrderVM.SpendYJBMoney > 0)
                                {
                                      <text>
                                          <div> 退款 @(commodityOrderVM.RefundMoney)元（含
                                              @commodityOrderVM.RefundScoreMoney 元积分；@commodityOrderVM.RefundYJBMoney 元易捷币）</div>
                                      </text>
                                }
                                else if (commodityOrderVM.SpendYJBMoney > 0)
                                {
                                      <text>
                                          <div> 退款 @(commodityOrderVM.RefundMoney)元（含
                                              @commodityOrderVM.RefundYJBMoney
                                              元易捷币）</div>
                                      </text>
                                }
                                else if (commodityOrderVM.SpendScoreMoney > 0)
                                {
                                      <text>
                                          <div> 退款 @(commodityOrderVM.RefundMoney)元（含
                                              @commodityOrderVM.RefundScoreMoney
                                              元积分）</div>
                                      </text>
                                }
                                else
                                {
                                      <text>
                                          <div> 退款 @commodityOrderVM.RefundMoney 元</div></text>
                                }
                            }
                          }
                        </div>
                    </td>
                    <td style="text-align: center; width:150px;" rowspan="@count"class="left_border">
                        @if (commodityOrderVM.Commission > 0)
                        {
                            <text>
                            <div>
                                众销佣金：@Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@commodityOrderVM.Commission.ToString("0.00")</div>
                            </text>  
                        }
                        @if (commodityOrderVM.IsCrowdfunding && commodityOrderVM.CfDividend.HasValue && commodityOrderVM.CfDividend.Value > decimal.Zero && commodityOrderVM.State != 0 && commodityOrderVM.State != 11)
                        {
                            decimal cfdividend = commodityOrderVM.CfDividend.HasValue ? commodityOrderVM.CfDividend.Value : 0.0m;
                            <text>
                            <div>
                                众筹佣金：@Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency() @string.Format("{0:0.00#}", cfdividend)</div></text>
                        }
                        @if (commodityOrderVM.SpreadGold > decimal.Zero)
                        { 
                            <text>
                            <div style="display: block;">
                                推广主佣金：@Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency() @string.Format("{0:0.00#}", (decimal)commodityOrderVM.SpreadGold / 1000)
                            </div></text>
                        }
                        @if (commodityOrderVM.OwnerShare > decimal.Zero)
                        { 
                            <text>
                            <div style="display: block;">
                                应用主佣金：@Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency() @string.Format("{0:0.00#}", commodityOrderVM.OwnerShare)
                            </div></text>
                        }
                        @if (commodityOrderVM.ChannelShareMoney > 0)
                        {
                            if (commodityOrderVM.State == 7 || commodityOrderVM.State == 3 && commodityOrderVM.StateAfterSales == 7)
                            {
                                //不显示
                            }
                            else
                            {
                            <div>
                                渠道佣金：@Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@commodityOrderVM.ChannelShareMoney.ToString("0.00")</div>   
                            }
                        }
                        @if (commodityOrderVM.DistributeMoney > 0)
                        {
                            <div>
                                分销佣金：@Jinher.AMP.BTP.UI.Util.WebUtil.GetCurrency()@commodityOrderVM.DistributeMoney.ToString("0.00")</div>   
                        }
                    </td>
                    <td style="text-align: center; width:100px;" rowspan="@count"class="left_border">
                        <div EsAppId='@commodityOrderVM.EsAppId'>@getEsAppName(commodityOrderVM.EsAppId, moneyToList, commodityOrderVM)</div>
                    </td>
                    <td style="text-align: center; width:100px;" rowspan="@count"class="left_border">
                        <div EsAppId='@commodityOrderVM.EsAppId' ordersource="@commodityOrderVM.EsAppId">
                        </div>
                    </td>
                    <td style="text-align: center; width:60px;" rowspan="@count"class="left_border">
                        <div>@(commodityOrderVM.InvoicePrintCount.HasValue ? commodityOrderVM.InvoicePrintCount.Value : 0)次</div>
                    </td>
                    <td style="text-align: center; width:60px;" rowspan="@count"class="left_border">
                        <div>@(commodityOrderVM.ExpressPrintCount.HasValue ? commodityOrderVM.ExpressPrintCount.Value : 0)次</div>
                    </td>
                    
                    <td style="text-align: center; width:60px;" rowspan="@count"class="left_border">
                        @if (commodityOrderVM.State == 0 || commodityOrderVM.State == 4 || commodityOrderVM.State == 6)
                        {
                            <span style="color:Gray;cursor:pointer;">设置</span>
                        }
                        else
                        {
                            if (commodityOrderVM.IsExistence == 0 && _objstr != null && _objstr.ToLower().Contains("sn"))
                            {  
                               <a  onclick="OpenIsExistence(this,'@commodityOrderVM.SubTime')" tag='@commodityOrderVM.Url' style="color: blue; cursor:pointer;">录入SN</a>
                            } 
                            else
                            {
                               <a  onclick="OpenIsExistence(this,'@commodityOrderVM.SubTime')" tag='@commodityOrderVM.Url' style="color: blue; cursor:pointer;">已完成</a>
                            }
                        }
                       
                    </td>
                    
                    <td style="text-align: center; width:150px;" rowspan="@count"class="left_border">
                        @if (commodityOrderVM.SellersRemark == null)
                        {
		 
                                            
                            <text><a href="javascript:;" id="addSellersRemark" onclick="SetSellersRemark(this,'@commodityOrderVM.CommodityOrderId','')">添加</a></text>
                            <div id="divSellersRemarks" style="display: none; width: 145px; word-wrap: break-word;
                                word-break: break-all;">
                                <span id="showSellersRemark" class="showSellersRemark" title=""></span>
                                <text>
                                    <a href="javascript:;" id="updateSellersRemark" onclick="SetSellersRemark(this,'@commodityOrderVM.CommodityOrderId','@commodityOrderVM.SellersRemark')">修改</a>&nbsp;&nbsp;&nbsp;
                                    @if (objstr.Contains("删除订单"))
                                    {
                                        <a href="#" id="delSellersRemark" onclick="delSellersRemark(this,'@commodityOrderVM.CommodityOrderId')">删除</a>
                                    }
                                </text>
                            </div>
                            
                        }
                        else
                        {
                            <text><a href="javascript:;" id="addSellersRemark" style=" display:none;" onclick="SetSellersRemark(this,'@commodityOrderVM.CommodityOrderId','')">添加</a></text>
                            <div id="divSellersRemarks" style="width: 145px; word-wrap: break-word; word-break: break-all;">
                                <span id="showSellersRemark"  class="showSellersRemark" title="@System.Web.HttpContext.Current.Server.UrlDecode(commodityOrderVM.SellersRemark)">@System.Web.HttpContext.Current.Server.UrlDecode(commodityOrderVM.SellersRemark)</span>
                                <text>
                                    <a href="javascript:;" id="updateSellersRemark" onclick="SetSellersRemark(this,'@commodityOrderVM.CommodityOrderId','@commodityOrderVM.SellersRemark')">修改</a>&nbsp;&nbsp;&nbsp;
                                    @if (objstr.Contains("删除订单"))
                                    {
                                        <a href="#" id="delSellersRemark" onclick="delSellersRemark(this,'@commodityOrderVM.CommodityOrderId')">删除</a>
                                    }
                                </text>
                            </div>
                        }
                        @if (!string.IsNullOrWhiteSpace(commodityOrderVM.PicturesPath))
                        {
                            <div>
                                <a href="javascript:;" onclick="showPicturesPath('@commodityOrderVM.PicturesPath.Replace("\\", "\\\\")')">
                                    查看附件</a></div>
                        }
                    </td>
                    <td align="center" rowspan="@count" class="right_sep">
                    </td>
                }
            </tr>
                }
            }
            <tr class="sep-row">
                <td colspan="13">
                </td>
            </tr>
        }
    </tbody>
</table>


<div style="display: none;" class="OrderDetailPar">
    <div id="IsExistence" style="margin: 0 auto;">
        <iframe id="IsExistenceurl" src="" width="100%;" height="100%" style="margin-bottom: 20px;
            border: 0px;"></iframe>
    </div>
</div>

<script type="text/javascript">

    if (window.parent) {
        $(window.parent.document).scrollTop(0);
    }

    $(document).ready(function () {

        $("#allCheck").on('click', function () {
            var s = document.getElementsByName("itemCheckBox");
            if ($(this).prop('checked')) {
                for (var i = 0; i < s.length; i += 1)
                    s[i].checked = "checked";
            } else {
                for (var i = 0; i < s.length; i += 1)
                    s[i].checked = "";
            }
        });
        $("input[name=itemCheckBox]").bind("click", function () {
            if ($("input[name=itemCheckBox]").length == $("input[name=itemCheckBox]:checked").length) {
                $("#allCheck").attr("checked", 'true')
            }
            else {
                $("#allCheck").removeAttr("checked")
            }
        });
        refreshOrderSource();
    })





    //获取值得改变
    function FirstSelectChange(tag, CommodityOrderId) {

        $(tag).parents(".left_border").find(".CaoZuo").find(".btn").remove();
        var _objstr = '@_objstr';
        var selectText = $(tag).find("option:selected").text();
        var html = '<a href="javascript:;" class="updates btn"  onclick="Updates(this,' + CommodityOrderId + ')" >确定</a><a style="margin-left:3px;" href="javascript:;" class="cancel btn">取消</a>';
        var _html = '<span  class="btn">确定</span><span  style="margin-left:3px;" class="btn">取消</span>';

        if (_objstr.indexOf("发货") != -1 && _objstr.indexOf("出库") != -1) {
            $(tag).parents(".left_border").find(".CaoZuo").append(html);
        }
        else {
            if (selectText == "出库中") {
                if (_objstr.indexOf("出库") == -1) {
                    $(tag).parents(".left_border").find(".CaoZuo").append(_html);
                }
                else {
                    $(tag).parents(".left_border").find(".CaoZuo").append(html);
                }
            }
            if (selectText == "已发货") {
                if (_objstr.indexOf("发货") == -1) {
                    $(tag).parents(".left_border").find(".CaoZuo").append(_html);
                }
                else {
                    $(tag).parents(".left_border").find(".CaoZuo").append(html);
                }
            }
        }

    }


    //获取值得改变
    function SecondSelectChange(tag, CommodityOrderId) {
 
        $(tag).parents(".left_border").find(".CaoZuo").find(".btn").remove();
        var _objstr = '@_objstr';
        var selectText = $(tag).find("option:selected").text();
        var html = '<a href="javascript:;" class="updates btn"  onclick="Updates(this,' + CommodityOrderId + ')" >确定</a><a style="margin-left:3px;" href="javascript:;" class="cancel btn">取消</a>';
        var _html = '<span  class="btn">确定</span><span style="margin-left:3px;"  class="btn">取消</span>';

        if (_objstr.indexOf("发货") != -1 && _objstr.indexOf("出库") != -1) {
            $(tag).parents(".left_border").find(".CaoZuo").append(html);
        }
        else {
            if (selectText == "出库中") {
                if (_objstr.indexOf("出库") == -1) {
                    $(tag).parents(".left_border").find(".CaoZuo").append(_html);
                }
                else {
                    $(tag).parents(".left_border").find(".CaoZuo").append(html);
                }
            }
            if (selectText == "已发货") {
                if (_objstr.indexOf("发货") == -1) {
                    $(tag).parents(".left_border").find(".CaoZuo").append(_html);
                }
                else {
                    $(tag).parents(".left_border").find(".CaoZuo").append(html);
                }
            }
        }

    }


//    $(".left_border").on("click", ".btn", function () {
//        var CommodityOrderId = $(this).attr("objcommodityOrderid");
//        Updates(this, CommodityOrderId);
//    })


    function OpenIsExistence(tar, time) {
        var canshu = $(tar).attr('tag');
        var dt = new Date(time).format("yyyy-MM-dd hh:mm:ss");
        canshu += ("&OrderTime=" + Base.encode(dt) + "&adminuserId=" + getQueryString("userId"));
        var url = "http://iustore.iuoooo.com/GoodsDetail/GoodsDetail?" + canshu;
        $("#IsExistenceurl").attr("src", url);
        $("#IsExistence").jhtablebox({
            title: "设置SN",
            width: 700,
            height: 600,
            draggable: true,
            modal: true,
            resizable: false,
            closedByHide: true
        });
       
    }

    ~(function (root, factory) {
        if (typeof define === "function" && define.amd) {
            define([], factory);
        } else if (typeof module === "object" && module.exports) {
            module.exports = factory();
        } else {
            root.Base = factory();
        }
    } (this, function () {
        'use strict';

        function Base64() {
            // private property
            this._keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
        }
        //public method for encoding
        Base64.prototype.encode = function (input) {
            var output = "", chr1, chr2, chr3, enc1, enc2, enc3, enc4, i = 0;
            input = this._utf8_encode(input);
            while (i < input.length) {
                chr1 = input.charCodeAt(i++);
                chr2 = input.charCodeAt(i++);
                chr3 = input.charCodeAt(i++);
                enc1 = chr1 >> 2;
                enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
                enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
                enc4 = chr3 & 63;
                if (isNaN(chr2)) {
                    enc3 = enc4 = 64;
                } else if (isNaN(chr3)) {
                    enc4 = 64;
                }
                output = output +
                    this._keyStr.charAt(enc1) + this._keyStr.charAt(enc2) +
                    this._keyStr.charAt(enc3) + this._keyStr.charAt(enc4);
            }
            return output;
        }

        // public method for decoding
        Base64.prototype.decode = function (input) {
            var output = "", chr1, chr2, chr3, enc1, enc2, enc3, enc4, i = 0;
            input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");
            while (i < input.length) {
                enc1 = this._keyStr.indexOf(input.charAt(i++));
                enc2 = this._keyStr.indexOf(input.charAt(i++));
                enc3 = this._keyStr.indexOf(input.charAt(i++));
                enc4 = this._keyStr.indexOf(input.charAt(i++));
                chr1 = (enc1 << 2) | (enc2 >> 4);
                chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
                chr3 = ((enc3 & 3) << 6) | enc4;
                output = output + String.fromCharCode(chr1);
                if (enc3 != 64) {
                    output = output + String.fromCharCode(chr2);
                }
                if (enc4 != 64) {
                    output = output + String.fromCharCode(chr3);
                }
            }
            output = this._utf8_decode(output);
            return output;
        }

        // private method for UTF-8 encoding
        Base64.prototype._utf8_encode = function (string) {
            string = string.replace(/\r\n/g, "\n");
            var utftext = "";
            for (var n = 0; n < string.length; n++) {
                var c = string.charCodeAt(n);
                if (c < 128) {
                    utftext += String.fromCharCode(c);
                } else if ((c > 127) && (c < 2048)) {
                    utftext += String.fromCharCode((c >> 6) | 192);
                    utftext += String.fromCharCode((c & 63) | 128);
                } else {
                    utftext += String.fromCharCode((c >> 12) | 224);
                    utftext += String.fromCharCode(((c >> 6) & 63) | 128);
                    utftext += String.fromCharCode((c & 63) | 128);
                }

            }
            return utftext;
        }

        // private method for UTF-8 decoding
        Base64.prototype._utf8_decode = function (utftext) {
            var string = "", i = 0, c = 0, c1 = 0, c2 = 0, c3 = 0;
            while (i < utftext.length) {
                c = utftext.charCodeAt(i);
                if (c < 128) {
                    string += String.fromCharCode(c);
                    i++;
                } else if ((c > 191) && (c < 224)) {
                    c2 = utftext.charCodeAt(i + 1);
                    string += String.fromCharCode(((c & 31) << 6) | (c2 & 63));
                    i += 2;
                } else {
                    c2 = utftext.charCodeAt(i + 1);
                    c3 = utftext.charCodeAt(i + 2);
                    string += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));
                    i += 3;
                }
            }
            return string;
        }

        var Base = new Base64();

        return Base;
    }));

</script>
