String.prototype.format=function(args){var result=this;if(arguments.length>0){if(arguments.length==1&&typeof(args)=="object"){for(var key in args){if(args[key]!=undefined){var reg=new RegExp("({"+key+"})","g");result=result.replace(reg,args[key])}}}else{for(var i=0;i<arguments.length;i++){if(arguments[i]!=undefined){var reg=new RegExp("({["+i+"]})","g");result=result.replace(reg,arguments[i])}}}}return result};$.fn.clicks=function(){var tag;var callback;if(arguments.length>1){tag=arguments[0];callback=arguments[1]}else{tag="";callback=arguments[0]}var startSize;this.on("touchstart",tag,function(e){startSize=e.changedTouches[0].pageY;e.stopPropagation();e.stopPropagation()}).on("touchend",tag,function(e){e.stopPropagation();e.preventDefault();var self=$(this);if(Math.abs(startSize-e.changedTouches[0].pageY)<10){callback(this,e)}});return this};var appId="11111111-1111-1111-1111-111111111111";!sessionStorage.page?sessionStorage.page=1:"";sessionStorage.categoryId="";sessionStorage.categoryLock="";sessionStorage.want="";sessionStorage.wantLock="";var advance=500;var multAttr=false;var maxHeight=0;var scrollLoading=false;var regNum=new RegExp("^0$|^[1-9]\\d*$");var isComHasVipInfo=false;$(function(){$("#main").css({minHeight:$(window).height()+$("#footer").height()})});function ajaxLoading(id,insertElement){var loading=$("#ajaxLoading_"+id);var blind=$("<div></div>");var insertElements=insertElement?$(insertElement):blind;blind.css({"position":"fixed","z-index":"10000","opacity":0.2,"backgroundColor":"#ccc","height":"100%","width":"100%","top":0,"left":0});blind.attr("id","ajaxLoadBlind");if(!insertElement){!$("#ajaxLoadBlind")[0]?$("body").append(blind):""}if(!loading.attr("id")){loading=$("<div></div>");loading.attr("id","ajaxLoading_"+id);loading.css({"position":"absolute","z-index":"99","left":"50%","margin-left":"-16px","top":"50%","margin-top":"-16px"});loading.append('<img src="/Content/images/ajax-loader.gif" />');insertElement?insertElements.css({"position":"relative"}):"";insertElements.append(loading);var windowParent=$(window.parent)}else{!insertElement?$("#ajaxLoadBlind").remove():loading.remove()}}var ajaxLoadingSingle=(function(){function initLoading(){var blind=$("body").find("#ajaxLoadBlind");if(blind.length>0){return}blind=$("<div></div>");blind.css({"position":"fixed","z-index":"10000","opacity":0.2,"backgroundColor":"#ccc","height":"100%","width":"100%","top":0,"left":0});blind.attr("id","ajaxLoadBlind");var loading=$("#ajaxLoading_img");loading=$("<div></div>");loading.attr("id","ajaxLoading_img");loading.css({"position":"absolute","z-index":"99","left":"50%","margin-left":"-16px","top":"50%","margin-top":"-16px"});loading.append('<img src="/Content/images/ajax-loader.gif" />');blind.append(loading);$("body").append(blind)}function show(){initLoading();var blind=$("body").find("#ajaxLoadBlind");if(blind.length==0){return}blind.show()}function hide(){var blind=$("body").find("#ajaxLoadBlind");if(blind.length==0){return}blind.hide()}var loadingSingle=new Object();loadingSingle.show=show;loadingSingle.hide=hide;return loadingSingle}());function getQueryString(name){var r;if(arguments.length>1){r=arguments[1].split("?")[1]}else{r=window.location.search.substr(1)}var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i");r=r.match(reg);if(r!=null){return unescape(r[2])}return null}function GoShop(id){var str=location.href;var tempStr=str;if(str.indexOf("?")!="-1"){var num=str.indexOf("?");str=str.substr(num+1);if(str.indexOf("commodityId=")!=-1){tempStr=tempStr.replace(str.substr(str.indexOf("commodityId=")+12,36),id);window.location.href=tempStr}else{tempStr+="&commodityId="+id}}else{window.location.href=str+"?commodityId="+id}}function setItemData1(obj){var clone_item=obj.element;var data=obj.data;clone_item.css({}).attr("data-id",data.RelationCommodityId);clone_item.find("img").parent().css({"height":Math.round(sessionStorage.img_height)+"px","overflow":"hidden"}).find("img").css("height",Math.round(sessionStorage.img_height)+"px").attr("src",data.CommodityPicturesPath).addClass("LazyLoad")[0].onerror=function(){console.log(self.css({background:"none"}).attr("src","/Content/Mobile/b_2.png"))};if(data.IsEnableSelfTake==1){clone_item.find(".selfTakeImg").attr("src","/Images/selftake.png").show()}else{clone_item.find(".selfTakeImg").attr("src","").hide()}clone_item.find(".item_title").text(data.Name);var isyou=false;if(data.DiscountPrice>0){clone_item.find(".price_1").text(getCurrency()+Math.abs(data.DiscountPrice).toFixed(2));clone_item.find(".price_2").text(getCurrency()+data.Price);clone_item.find(".zk").text("优惠价");isyou=true}else{if(data.Intensity==10){clone_item.find(".price_1").text(getCurrency()+data.Price);if(data.MarketPrice&&data.MarketPrice!=null&&data.MarketPrice!="null"){clone_item.find(".price_2").text(getCurrency()+data.MarketPrice)}else{clone_item.find(".price_2").hide()}}else{clone_item.find(".price_1").text(getCurrency()+Math.abs(data.Price*(data.Intensity/10)).toFixed(2));clone_item.find(".price_2").text(getCurrency()+data.Price);
isyou=true}data.Intensity!=10?clone_item.find(".zk").text(data.Intensity+"折"):""}clone_item.bind("click",function(){GoShop($(this).attr("data-id"))});var lim="";if(isyou==true&&sessionStorage.ProductType!="appcjzy"&&sessionStorage.ProductType!="webcjzy"){if(data.LimitBuyEach>-1&&data.LimitBuyEach){lim+="每人限购"+data.LimitBuyEach+"件,"}else{lim+="不限购,"}if(data.LimitBuyTotal>-1&&data.LimitBuyTotal){lim+="还剩"+(parseInt(data.LimitBuyTotal)-parseInt(data.SurplusLimitBuyTotal))+"件"}else{lim+="还剩"+data.Stock+"件"}clone_item.find(".yhzknum").text(lim)}!(data.Stock>0)?clone_item.find(".mb_box").removeClass("noDisplay"):"";data.State==1?clone_item.find(".mb_box").removeClass("noDisplay").find(".mb_1").text("已下架"):"";return clone_item}function setRelationCommoditys(relationCommoditys){var items=$("#items");var item=$("#parent_item");var height=item.height();var img_height=item.find("img").height();var clone_item;$("#items").html("");$("#itemsListMode").html("");_commodityListData=[];if(relationCommoditys!=null&&relationCommoditys.length>0){for(var i=0;i<relationCommoditys.length;i++){clone_item=item.clone().removeClass("noDisplay").attr("id","");items.append(setItemData1({element:clone_item,data:relationCommoditys[i],height:height,img_height:img_height}))}}else{$("#RelationProduct").hide()}}function noCommodityDetail(){$("#ajaxLoadBlind").remove();$("#box").html($("#divNotLoginTemplate").html())}function getCommodityInfo(document,callback){sessionStorage.commodityUpInfo="";sessionStorage.isSecKill="";sessionStorage.startSecKillTime="";sessionStorage.commodityId_2=getQueryString("commodityId");var data={appId:getEsAppId(),commodityId:sessionStorage.commodityId_2||getQueryString("commodityId"),freightTo:sessionStorage.province,outPromotionId:getQueryString("outPromotionId"),source:sessionStorage.source};if(isLogin()){data.userId=getUserId()}getDataAjax({url:"/Mobile/GetCommodityDetailsZPH?r="+Math.random(),data:data,callback:function(data){if(!data||data.ResultCode!=0){noCommodityDetail()}setData(data)},beforeSend:function(){ajaxLoading("22","")}});function setPriceRange(commodity){$(".u-detail-pricebox").show();if(!commodity){commodity=JSON.parse(sessionStorage.commodityInfo)}sessionStorage.DiscountPrice=-1;$("#minPrice").hide();$(".oldPrice").hide();var minPriceShow=false;var minMarketPriceShow=false;var minPrice=commodity.Price;var maxPrice=commodity.Price;var minMarketPrice=commodity.MarketPrice;var maxMarketPrice=commodity.MarketPrice;if(commodity.CommodityStocks&&commodity.CommodityStocks.length>0){minPrice=999999999;maxPrice=0;minMarketPrice=999999999;maxMarketPrice=0;for(var j=0;j<commodity.CommodityStocks.length;j++){if(commodity.CommodityStocks[j].Price<minPrice){minPrice=commodity.CommodityStocks[j].Price}if(commodity.CommodityStocks[j].Price>maxPrice){maxPrice=commodity.CommodityStocks[j].Price}if(commodity.CommodityStocks[j].MarketPrice&&commodity.CommodityStocks[j].MarketPrice!=null&&commodity.CommodityStocks[j].MarketPrice!="null"&&commodity.CommodityStocks[j].MarketPrice<minMarketPrice){minMarketPrice=commodity.CommodityStocks[j].MarketPrice}if(commodity.CommodityStocks[j].MarketPrice&&commodity.CommodityStocks[j].MarketPrice!=null&&commodity.CommodityStocks[j].MarketPrice!="null"&&commodity.CommodityStocks[j].MarketPrice>maxMarketPrice){maxMarketPrice=commodity.CommodityStocks[j].MarketPrice}}if(minPrice<maxPrice){minPriceShow=true}if(minMarketPrice<maxMarketPrice){minMarketPriceShow=true}}setSessionStorage.minPriceShow=minPriceShow;sessionStorage.minPrice=minPrice;sessionStorage.maxPrice=maxPrice;if(commodity.DiscountPrice>0){$(".oldPrice").show();sessionStorage.DiscountPrice=commodity.DiscountPrice;$("#maxPrice").text(Math.abs(commodity.DiscountPrice).toFixed(2));if(!minPriceShow){$("#minOldPrice").hide()}else{$("#minOldPrice").show().text(Math.abs(minPrice).toFixed(2)+"-")}$("#maxOldPrice").show().text(Math.abs(maxPrice).toFixed(2))}else{if(commodity.Intensity<10){$(".oldPrice").show();if(!minPriceShow){$("#minPrice").hide();$("#minOldPrice").hide()}else{$("#minPrice").show().text(Math.abs(minPrice*(commodity.Intensity/10)).toFixed(2)+"-");$("#minOldPrice").show().text(Math.abs(minPrice).toFixed(2)+"-")}$("#maxPrice").text(Math.abs(maxPrice*(commodity.Intensity/10)).toFixed(2));$("#maxOldPrice").show().text(Math.abs(maxPrice).toFixed(2))}else{if(minPriceShow){$("#minPrice").show().text(Math.abs(minPrice).toFixed(2)+"-")}$("#maxPrice").text(Math.abs(maxPrice).toFixed(2));if(commodity.MarketPrice&&commodity.MarketPrice!=null&&commodity.MarketPrice!="null"){$(".oldPrice").show();if(minMarketPriceShow){$("#minOldPrice").show().text(Math.abs(minMarketPrice).toFixed(2)+"-")}$("#maxOldPrice").show().text(Math.abs(maxMarketPrice).toFixed(2))}}}}function setFreightToDetails(comId){$(".u-link-select").show();var req={commodityId:comId};getDataAjax({url:"/Mobile/GetFreightDetails",data:req,callback:function(result){$("#provinceSel").empty();if(result&&result.ResultCode==0&&result.FreightList.length>0){for(var i=0;i<result.FreightList.length;
i++){var optionVal=result.FreightList[i].FreightTo+"_"+result.FreightList[i].Freitht;var option=$("<option>").val(optionVal).text(result.FreightList[i].FreightTo);$("#provinceSel").append(option);if(result.FreightList[i].FreightTo==sessionStorage.province){$("#provinceSel").val(optionVal)}}}},})}function setData(comDetailResult){var data=comDetailResult.CommodityInfo;var appDownLoadInfo=comDetailResult.AppDownLoadInfo;contactUrl=comDetailResult.ContactUrl;appName=comDetailResult.EsAppName;_contactObj=comDetailResult.ContactObj;var isShowvolume=comDetailResult.ResultIsVolume;var img=$("<img/>");var imgBox=document.find("#img");var imgList=imgBox.find("ul");var property=document.find("#property");var content_box=document.find("#content_box");var content_2_clone=document.find("#content_2_clone");var nowDate=data.CurrentTime?data.CurrentTime.split("(")[1].split(")")[0]:(new Date()).getTime();var tmpImg;var lastTime="";sessionStorage.commodityInfo=JSON.stringify(data);sessionStorage.appId=data.AppId;sessionStorage.State=data.State;isAppSet=data.IsAppSet;sessionStorage.PresellEndTime=getRemainingTime(data.PresellEndTime,"0",nowDate);lastTime=sessionStorage.PresellEndTime==="0"?sessionStorage.PresellEndTime:data.PresellEndTime;sessionStorage.PromotionStartTime=getRemainingTime(data.PromotionStartTime,lastTime,nowDate);lastTime=sessionStorage.PromotionStartTime==="0"?sessionStorage.PromotionStartTime:data.PromotionStartTime;sessionStorage.PromotionEndTime=getRemainingTime(data.PromotionEndTime,lastTime,nowDate);sessionStorage.PreselledNum=data.PreselledNum||0;sessionStorage.PromotionState=data.PromotionState;sessionStorage.CommidotyId=getQueryString("commodityId");sessionStorage.OutPromotionId=data.OutPromotionId;sessionStorage.PromotionType=data.PromotionType;sessionStorage.total=data.Total;$("#total").find("span").text(data.Total);if(isShowvolume==false){$("#total").hide()}else{$("#total").show()}sessionStorage.RealStock=data.Stock;if((data.DiscountPrice>-1||data.Intensity<10)&&data.LimitBuyTotal>0){var realStock=parseInt(data.LimitBuyTotal)-parseInt(data.SurplusLimitBuyTotal);property.find(".type_4").text(realStock);sessionStorage.RealStock=realStock;property.find(".type_5").text(parseInt(data.SurplusLimitBuyTotal))}else{property.find(".type_4").text(data.Stock);property.find(".type_5").text(data.Total)}if(data.Stock<=0){if(JsVilaDataNull(data.DiyGroupPromotion)){$("#promotionMsg").children("div").html("已售完");$("#btnDirectBuy").addClass("disabled");$("#btnDiyGroup").addClass("disabled")}else{$("#promotionMsg").children("div").html("已抢光")}$("#promotionMsg").show()}showSateByPromotion(data.PromotionState||0,data.PromotionType||0,sessionStorage.RealStock||0);setPriceRange(data);$("#title").text(data.Name);if(data.VideoWebUrl){$("#Mvideo").show();$("#MVPVideo").attr("poster",data.VideoPicUrl);$("#MVPVideo").attr("src",data.VideoWebUrl)}setSessionStorage("commodityUpInfo","name",data.Name);$("#freight").text(Math.abs(data.Freight||0).toFixed(2));if(data.IsSetMulti){setFreightToDetails(data.Id)}else{$("#provinceSel").hide()}setSessionStorage("commodityUpInfo","price",Math.abs(data.Price).toFixed(2));property.find(".type_6").text(data.CollectNum);var contents=$(data.Description);contents.find("img").attr("width","").attr("height","").css("width","100%");content_box.find(".content_1").html(contents);$("#reviewCount").text(data.ReviewNum);window.ReviewNum=data.ReviewNum;imgList.find("li").remove();if(data.Pictures){for(var i=0;i<data.Pictures.length;i++){imgList.append(img.clone().attr("src",data.Pictures[i].PicturesPath))}}if(data.RelationCommoditys!=null){$("#RelationProduct").show();for(var i=0;i<data.RelationCommoditys.length;i++){var tempImg='<img style="width: 23%; height: auto;" src="'+data.RelationCommoditys[i].CommodityPicturesPath+'" onclick="GoShop(\''+data.RelationCommoditys[i].RelationCommodityId+"')\" />";$("#RelationProductImg").append(tempImg)}}tmpImg=img.clone().attr("src","/Content/Mobile/2.jpg?"+new Date().getTime());tmpImg[0].onload=function(){callback()};setSessionStorage("commodityUpInfo","Intensity",data.Intensity);setSessionStorage("commodityUpInfo","pic",data.Pic);setSessionStorage("commodityUpInfo","marketPrice",Math.abs(data.MarketPrice).toFixed(2));setSessionStorage("commodityUpInfo","IsEnableSelfTake",data.IsEnableSelfTake);setSessionStorage("commodityUpInfo","number","1");setSessionStorage("commodityUpInfo","CommodityType",data.CommodityType);setSessionStorage("commodityUpInfo","orderType",data.CommodityType);numberEvent();setRelationCommoditys(data.RelationCommoditys);data.IsEnableSelfTake==1?$(".selfTake").removeClass("noDisplay"):"";data.IsEnableSelfTake==1?$("#selfTakeFlag").val(1):$("#selfTakeFlag").val(0);var arrSimple=new Array();var le=data.CommodityStocks.length;var length=0;if(data.CommodityStocks.length>0){for(var j=0;j<le;j++){if(data.CommodityStocks[j].Duty>0){arrSimple.push(data.CommodityStocks[j].Duty);length++}}arrSimple.sort(sortNumber);if(length>0){if(length>1){$("#divDuty").html(arrSimple[0].toFixed(2)+" ~ "+arrSimple[length-1].toFixed(2))
}else{$("#divDuty").html(arrSimple[0].toFixed(2))}$("#DivDutys").show()}else{$("#DivDutys").hide()}}else{if(data.Duty!=null&&parseFloat(data.Duty)>0){$("#divDuty").html(data.Duty);$("#DivDutys").show()}else{$("#DivDutys").hide()}}if(data.FreeFreightStandard!=null){var partial="";if(data.FreeFreightStandard.length==1){partial+=data.FreeFreightStandard[0]+"<br />"}else{for(var i=0;i<data.FreeFreightStandard.length;i++){partial+=(i+1)+". "+data.FreeFreightStandard[i]+"<br />"}}partial+="具体运费以下订单时显示为准";$("#partialFree").html(partial)}if(data.SharePercent!=null&&parseFloat(data.SharePercent)>0){var commission=(data.Price*data.SharePercent).toFixed(2);$("#spanCommission .commission").html(getCurrency()+commission);$("#spanCommission").show()}else{$("#spanCommission").hide()}$("#spanAppName").text(data.AppName);if(data.IsDistribute){$("#divDistribute51").show()}else{$("#divDistribute51").hide()}if(sessionStorage.source=="share"&&appDownLoadInfo&&JsVilaDataNull(appDownLoadInfo.Icon)){$("#esAppLogo").attr("src",appDownLoadInfo.Icon);if(JsVilaDataNull(appDownLoadInfo.PromotionDownGuide)){$("#esAppDesc").html(appDownLoadInfo.PromotionDownGuide)}$("#dwEsAppId").show()}if(data.IsDistribute&&data.AppId==getEsAppId()&&sessionStorage.source=="share"){$("#divRegOrDownloadTip").show();$("#dwEsAppId").hide()}else{$("#divRegOrDownloadTip").hide()}if(isLogin()){$("#pDownload").show();$("#pRegist").hide()}else{$("#pDownload").hide();$("#pRegist").show()}if(JsVilaDataNull(data.DiyGroupPromotion)){showDiyGroupDetail(data);$("#divVipMember").hide()}else{if(data.VipPromotion&&data.VipPromotion.IsVipActive){if(isLogin()){showVipPriceLogin(data.VipPromotion)}else{var commodityInfo=JSON.parse(sessionStorage.commodityInfo);var promotionType=commodityInfo.PromotionTypeNew;if(promotionType==9999){$("#divVipMember").show()}else{$("#divVipMember").hide()}}}}if(isLogin()){isComHasVipInfo=true}}function showDiyGroupDetail(data){var diyg=data.DiyGroupPromotion;$("#divPriceDiy").show();$("#promotionDesc").html(diyg.Description);var minMarketPrice=0,maxMarketPrice=0;if(data.CommodityStocks&&data.CommodityStocks.length){for(var j=0;j<data.CommodityStocks.length;j++){var commodity=data.CommodityStocks[j];if(commodity.MarketPrice&&commodity.MarketPrice!=null&&commodity.MarketPrice!="null"&&(commodity.MarketPrice<minMarketPrice||minMarketPrice==0)){minMarketPrice=commodity.MarketPrice}if(commodity.MarketPrice&&commodity.MarketPrice!=null&&commodity.MarketPrice!="null"&&commodity.MarketPrice>maxMarketPrice){maxMarketPrice=commodity.MarketPrice}}}if(data.MaxSkuPrice>data.MinSkuPrice){$("#spanPriceDiy").html(getCurrency()+data.MinSkuPrice+"~"+data.MaxSkuPrice);$("#btnDiyGroup div.open-group-price").html(getCurrency()+data.MinSkuPrice);if(minMarketPrice<maxMarketPrice){$("#spanPriceOri").html(getCurrency()+minMarketPrice+"~"+maxMarketPrice)}else{$("#spanPriceOri").html(getCurrency()+data.MinPrice+"~"+data.MaxPrice)}$("#btnDirectBuy div.alone-buy-price").html(getCurrency()+data.MinPrice)}else{$("#spanPriceDiy").html(getCurrency()+data.DiscountPrice);$("#btnDiyGroup div.open-group-price").html(getCurrency()+data.DiscountPrice);$("#spanPriceOri").html(getCurrency()+data.Price);$("#btnDirectBuy div.alone-buy-price").html(getCurrency()+data.Price)}$("#spanJoinPersonCount").html(data.AlreadyJoinCount);$("#btnDiyGroup div.open-group-go span:last").html(data.DiyGroupPromotion.GroupMinVolume);if(JsVilaDataNull(getQueryString("diyGroupId"))){$("#btnDiyGroup div.open-group-go span:first").html("参")}else{$("#btnDiyGroup div.open-group-go span:first").html("开")}if(diyg.SurplusLimitBuyTotal>=diyg.LimitBuyTotal){$("#btnDiyGroup").addClass("disabled")}if(diyg.PromotionState==0||diyg.PromotionState==4){$("#promotionMsg").children("div").html("已结束");$("#promotionMsg").show();$("#btnDiyGroup").addClass("disabled")}}function getRemainingTime(serverTime,preTime,nowDate){var resTime=0;if(serverTime){if(preTime==="0"){resTime=(serverTime.split("(")[1].split(")")[0]-nowDate)/1000}else{resTime=(serverTime.split("(")[1].split(")")[0]-(preTime.split("(")[1].split(")"))[0])/1000}if(resTime<0){resTime=0}}else{resTime=0}return resTime}function showSateByPromotion(promotionState,promotionType,stock){var promotionTemplate="";if(stock==="0"){promotionState=5}if(promotionType===0){normalEvent()}else{if(promotionType===1){seckillEvent(promotionState)}else{if(promotionType===2){presellEvent()}else{if(promotionType===3){}else{}}}}function normalEvent(){var cmdtyProperties=$("#cmdtyProperties");if(cmdtyProperties.children().length<=0){promotionTemplate='<p class="u-detail-pricebox clearFloat">'+'<span class="u-detail-price">'+getCurrency()+'</span> <span id="minPrice" class="u-detail-price u-detail-price2">'+'</span><span id="maxPrice" class="u-detail-price u-detail-price2"></span><span class="u-detail-mprice oldPrice">'+"<span>"+getCurrency()+'</span> <span id="minOldPrice"></span><span id="maxOldPrice"></span></span>'+'<span class="u-detail-discount" class="color_1 type_1 " id="crowdwin" style="display: none;">'+"众筹中</span>"+"</p>";
cmdtyProperties.html(promotionTemplate)}}function seckillEvent(promotionState){switch(promotionState){case 0:normalEvent();break;case 2:case 3:normalEvent();procSeckillCommodity(promotionState);break;case 4:case 5:normalEvent();procPromotion45(promotionType,promotionState);break}setNotiSate()}function presellEvent(){processPmtTemplate(promotionState)}function procSeckillCommodity(promotionState){var pTpt="";var pTptBtn="";var promotionTemplate="";var footer=$("#footer");var timestamp=0;var cmdtyProperties=$("#cmdtyProperties");if(promotionState===2){timestamp=sessionStorage.PromotionStartTime;promotionTemplate='<div id="prmTimerDiv" style="padding-left: 16px;">'+"<span>"+'<span>距开抢时间：</span><span id="prm_day_show"></span><span>天</span>'+'<span id="prm_hour_show"></span><span>：</span>'+'<span id="prm_minute_show"></span><span>：</span>'+'<span id="prm_second_show"></span>'+"</span>"+'<span id="sendNotifications" style="margin-left: 10px;width: 80px;height: 27px;line-height: 27px;display: inline-block;border-radius: 3px;">设置提醒</span>'+"</div>";footer.html(promotionTemplate)}else{if(promotionState===3){promotionTemplate='<div class="footer_4" id="addshopcart" style="margin-right: 5px; margin-left: 0;padding : 3.5% 8%;opacity: .8;">'+"加入购物车</div>"+'<div class="footer_2" style="padding: 3.5% 8% !important;   border-radius: 4px; background-color: rgb(255, 0, 84);  text-align: center; color: #fff; font-size: 1.3em; letter-spacing: 3px; display: inline-block;">'+"立即抢购</div>";timestamp=sessionStorage.PromotionEndTime;footer.html(promotionTemplate)}}prmTimer(timestamp,{day:$("#prm_day_show")||null,hour:$("#prm_hour_show")||null,minute:$("#prm_minute_show")||null,second:$("#prm_second_show")||null},function(){if(promotionState===2){seckillEvent(3)}else{if(promotionState===3){procPromotion45(2,4)}}})}function processPmtTemplate(promotionState){switch(promotionState){case 0:normalEvent();break;case 1:case 2:case 3:procPromotion123(promotionState);break;case 4:case 5:normalEvent();procPromotion45(promotionType,promotionState);break}}function procPromotion123(promotionState){var pTpt="";var pTptBtn="";var promotionTemplate="";var footer=$("#footer");var timestamp=0;var cmdtyProperties=$("#cmdtyProperties");if(promotionState!==3){promotionTemplate='<div class="footer_4" id="addshopcart" style="margin-right: 5px; margin-left: 0;padding : 3.5% 8%;opacity: .8;">'+"加入购物车</div>"+'<div id="prmPresell" style="padding: 3.5% 8% !important;   border-radius: 4px; background-color: rgb(255, 0, 84);  text-align: center; color: #fff; font-size: 1.3em; letter-spacing: 3px; display: inline-block;">'+"购买</div>";footer.html(promotionTemplate)}if(promotionState===1){pTpt="距预约结束";pTptBtn="立即预约";timestamp=sessionStorage.PresellEndTime;subscribeNow()}else{if(promotionState===2){pTpt="距抢购开始";pTptBtn="立即抢购";timestamp=sessionStorage.PromotionStartTime;footer.children("div").css({"background-color":"#E0E0E0","color":"#505050"})}else{if(promotionState===3){pTpt="距抢购结束";pTptBtn="立即抢购";timestamp=sessionStorage.PromotionEndTime;promotionTemplate='<div class="footer_4" id="addshopcart" style="margin-right: 5px; margin-left: 0px; color: gray;padding: 3.5% 8%;opacity: .8;">加入购物车</div>'+'<div class="footer_2" style="padding: 3.5% 8% !important;">立即抢购</div>';footer.children("div").filter(".footer_2").attr("style","padding: 3.5% 12% !important;");footer.html(promotionTemplate)}}}if(footer.children("div").filter("#prmPresell").length!==0){footer.children("div").filter("#prmPresell")[0].innerHTML=pTptBtn}else{footer.children("div").filter(".footer_2")[0].innerHTML=pTptBtn}if(cmdtyProperties.children("div").length>0){}else{promotionTemplate='<div style="padding-left: 0;  margin-bottom: .3rem;">'+'<span style=" clear:both;">预售价：</span><span style="color: #FF0054;" class="yuan">'+getCurrency()+'</span> <span id="minPrice" class="u-detail-price2" style="color: #FF0054;">'+'</span><span id="maxPrice" class="u-detail-price2" style="color: #FF0054;"></span><span style="margin: -1rem 1rem 0 2rem; color: #999; text-decoration: line-through; font-size: .9rem;">'+"<span>"+getCurrency()+'</span> <span id="minOldPrice"></span><span id="maxOldPrice"></span></span>'+'<span class="color_1 type_1" id="crowdwin" style="display: none;">'+"众筹中</span>"+"</div>";$("#cmdtyProperties").html(promotionTemplate)}var prmTimerDiv="<span>"+pTpt+'</span><span style=" color:#ff0054;" class="remain_t">（'+'<span>还剩</span><span id="prm_day_show"></span><span>天</span>'+'<span id="prm_hour_show"></span><span>小时</span>'+'<span id="prm_minute_show"></span><span>分</span>'+'<span id="prm_second_show"></span><span>秒</span>'+"）</span>";$("#prmTimerDiv").html(prmTimerDiv).show();$("#spanCommission").css("top",-5);prmTimer(timestamp,{day:$("#prm_day_show"),hour:$("#prm_hour_show"),minute:$("#prm_minute_show"),second:$("#prm_second_show")},function(){if(promotionState===1){sessionStorage.PromotionState=2;processPmtTemplate(2)}else{if(promotionState===2){sessionStorage.PromotionState=3;processPmtTemplate(3)}else{if(promotionState===3){sessionStorage.PromotionState=4;
procPromotion45(1,4)}}}})}function procPromotion45(promotionType,promotionState){var footer=$("#footer"),promotionTemplate="",proMsg=$("#promotionMsg"),msg="";if(promotionType===1){pTptBtn="立即抢购"}else{if(promotionType===2){pTptBtn="立即抢购"}}if(promotionState===5){msg="已抢光"}else{if(promotionState===4){msg="已结束"}}proMsg.show().children("div").html(msg);promotionTemplate='<div class="footer_4" id="addshopcart" style="margin-right: 5px; margin-left: 0;padding : 3.5% 8%;opacity: .8;">'+"加入购物车</div>"+'<div style="padding: 3.5% 8%; border-radius: 4px; background-color: rgb(255, 0, 84);  text-align: center; color: #fff; font-size: 1.3em; letter-spacing: 3px; display: inline-block;  opacity: .8;">'+""+pTptBtn+"</div>";footer.html(promotionTemplate);footer.children("div").css({"background-color":"#E0E0E0","color":"#505050"})}function subscribeNow(){var txtVali=$("#val-txtVali"),valValImg=$("#val-valImg");txtVali.focus(function(){if(valValImg.attr("src").indexOf("/mobile/GetVerifyCodeZPH")<0){valValImg.attr("src",getBtpDomain()+"mobile/GetVerifyCodeZPH?r="+Math.random())}});valValImg.on("click",function(){$("#val-valImg").attr("src",getBtpDomain()+"mobile/GetVerifyCodeZPH?r="+Math.random())});$("#val-cancel").on("click",function(){closeVali()});$("#btnGotoMyPresell").on("click",function(){window.location=zphUrl+"Presell/MyPresellComdty?userId="+getUserId()+"&sessionId="+getSessionId()+"&ChangeOrg=00000000-0000-0000-0000-000000000000&btpdomain="+window.location.host});$(".okMsgClose").on("click",function(){closeVali()});$("#val-submit").on("click",function(){var valVali=$.trim(txtVali.val()),outPromotionId=sessionStorage.OutPromotionId;if(promotionState!==1||valVali===""||outPromotionId===""){return false}var sendData={outPromotionId:outPromotionId,userId:getUserId(),sessionId:getSessionId(),verifyCode:valVali,esAppId:getEsAppId()};getDataAjax({url:"/mobile/SaveMyPresellComdtyZPH",data:sendData,callback:function(result){$("#val-valImg").attr("src",getBtpDomain()+"mobile/GetVerifyCodeZPH?r="+Math.random());txtVali.val("");if(result.ResultCode===2){toast(result.Message)}else{if(result.ResultCode===0){$("#valGetDiv").hide();$("#okMsgDiv").show().children("p").html("商品预约成功，您已经获得抢购资格，请关注抢购时间~~~")}else{if(result.ResultCode===1){$("#valGetDiv").hide();$("#okMsgDiv").show().children("p").html("您已成功预约过了，无需重复预约，请关注抢购时间~~~")}}}$("#ajaxLoadBlind").remove()},beforeSend:function(){ajaxLoading("22","")}});return false})}function closeVali(){$("#val-overlay").hide();$("#val-txtVali").val("");$("#val-valImg").attr("src","")}function setNotiSate(){if(!JsVilaDataNull(getUserId())){$("#sendNotifications").text("设置提醒");return}var sendData={skId:sessionStorage.OutPromotionId,uId:getUserId()};getDataAjax({url:"/mobile/SetNotificationState",data:sendData,callback:function(result){if(result.state){$("#sendNotifications").text("取消提醒")}else{$("#sendNotifications").text("设置提醒")}$("#ajaxLoadBlind").remove()},beforeSend:function(){ajaxLoading("22","")}})}}}function prmTimer(timestamp,timeElement,callback){var day=0,hour=0,minute=0,second=0;var prm=window.setInterval(function(){var intDiff=parseInt(timestamp);if(intDiff>=1){day=Math.floor(intDiff/(60*60*24));hour=Math.floor(intDiff/(60*60))-(day*24);minute=Math.floor(intDiff/60)-(day*24*60)-(hour*60);second=Math.floor(intDiff)-(day*24*60*60)-(hour*60*60)-(minute*60);if(minute<=9){minute="0"+minute}if(second<=9){second="0"+second}if(timeElement.day!==null){timeElement.day.html("<s></s>"+day);timeElement.hour.html("<s></s>"+hour);timeElement.minute.html("<s></s>"+minute);timeElement.second.html("<s></s>"+second)}--timestamp}else{if(timeElement.day!==null){timeElement.day.html("<s></s>"+"0");timeElement.hour.html("<s></s>"+"00");timeElement.minute.html("<s></s>"+"00");timeElement.second.html("<s></s>"+"00")}clearInterval(prm);callback();return}},1000)}function setSessionStorage(key,p_key,value){var data;if(!sessionStorage[key]){sessionStorage[key]="{}";data={}}else{data=JSON.parse(sessionStorage[key])}data[p_key]=value;sessionStorage[key]=JSON.stringify(data)}var _minBuyNum=1;function numberEvent(){var box=$("#number");var number=box.find(".span_number");var text=parseInt(number.val());var f_arguments=arguments;var limitBuyEach=-1;setSessionStorage("commodityUpInfo","number",text);box.on("click",".span_2",function(){text=parseInt(number.val());if(text-_minBuyNum<=0){return}if($(".plus").hasClass("hide")){$(".plus").removeClass("hide");$(".dis-plus").addClass("hide")}text-=1;text=sessionStorage.Stock!="已售完"?text:"已售完";number.val(text);setSessionStorage("commodityUpInfo","number",text);$("#pre_money_count").text(getCurrency()+Math.abs(sessionStorage.Price*text).toFixed(2));if(text<=sessionStorage.Stock){$("#txtMaxStock").hide()}f_arguments.length?f_arguments[0](text):"";JsCrowdfund();calcCommodityFreight();specBtn()}).on("click",".span_3",function(){var commodityInfo=JSON.parse(sessionStorage.commodityInfo);text=parseInt(number.val());limitBuyEach=commodityInfo?commodityInfo.LimitBuyEach:limitBuyEach;if(limitBuyEach!==null&&limitBuyEach!==-1&&text>=limitBuyEach){return
}number.val(text<sessionStorage.Stock?text+=1:sessionStorage.Stock);if(text>=sessionStorage.Stock){$(this).addClass("hide");$(".dis-plus").removeClass("hide");return}setSessionStorage("commodityUpInfo","number",text);$("#pre_money_count").text(getCurrency()+Math.abs(sessionStorage.Price*text).toFixed(2));$("#txtMaxStock").text("库存仅剩"+sessionStorage.Stock+"件");if(text>sessionStorage.Stock){$("#txtMaxStock").show()}f_arguments.length?f_arguments[0](text):"";specBtn();JsCrowdfund();calcCommodityFreight()});$(".span_number").on("keyup",function(){var v=$(this).val();v=v.replace(/[^\d]/g,"");v=v.replace(/^0/g,"")});$(".span_number").on("change",function(){var v=$(this).val();if(!regNum.test(v)){$(this).val(_minBuyNum);$(this).focus();return}if(v==""||v==0){v=_minBuyNum;$(this).val(v)}var commodityInfo=JSON.parse(sessionStorage.commodityInfo);var commodityUpInfo=JSON.parse(sessionStorage.commodityUpInfo);var prevNum=commodityUpInfo.number;var limitBuyEach=-1;limitBuyEach=commodityInfo?commodityInfo.LimitBuyEach:limitBuyEach;if(limitBuyEach!==null&&limitBuyEach!==-1&&v>=limitBuyEach){$(this).val(prevNum);return}v=parseInt(v)<parseInt(sessionStorage.Stock)?v:sessionStorage.Stock;$(this).val(v);setSessionStorage("commodityUpInfo","number",v);$("#pre_money_count").text(getCurrency()+Math.abs(sessionStorage.Price*v).toFixed(2));$("#txtMaxStock").text("库存仅剩"+sessionStorage.Stock+"件");if(parseInt(v)>parseInt(sessionStorage.Stock)){$("#txtMaxStock").show()}JsCrowdfund();calcCommodityFreight()})}function calcCommodityFreight(cinfo){if($("#freightTo").length==0){return}var str="";var commodityUpInfo=null;if(JsVilaDataNull(cinfo)){commodityUpInfo=cinfo}else{commodityUpInfo=JSON.parse(sessionStorage.commodityUpInfo)}var subData=new Array();subData.push({AppId:sessionStorage.appId,CommodityId:sessionStorage.commodityId_2,Count:commodityUpInfo.number,Price:commodityUpInfo.realPrice});var cparam={};cparam.templateCounts=subData;cparam.freightTo=$("#freightTo").html();cparam.isSelfTake=commodityUpInfo.IsEnableSelfTake;var strjson=JSON.stringify(cparam);getDataAjax2({url:"/Mobile/CalFreight",data:strjson,callback:function(result){if(result.ResultCode==0){var freight=Math.abs(result.Freight).toFixed(2);$("#freight").html(freight);setSessionStorage("commodityUpInfo","freight",freight)}}})}function getFormatDate(day){var Year=0;var Month=0;var Day=0;var Hour=0;var Minute=0;var Second=0;var CurrentDate="";Year=day.getFullYear();Month=day.getMonth()+1;Day=day.getDate();Hour=day.getHours();Minute=day.getMinutes();Second=day.getSeconds();CurrentDate+=Year+"-";if(Month>=10){CurrentDate+=Month+"-"}else{CurrentDate+="0"+Month+"-"}if(Day>=10){CurrentDate+=Day}else{CurrentDate+="0"+Day}CurrentDate+=" ";if(Hour>=10){CurrentDate+=Hour+":"}else{CurrentDate+="0"+Hour+":"}if(Minute>=10){CurrentDate+=Minute+":"}else{CurrentDate+="0"+Minute+":"}if(Second>=10){CurrentDate+=Second}else{CurrentDate+="0"+Second}return CurrentDate}function reviewScrollEvent(){if(window.location.hash!="#review"){return}if(scrollLoading==false){var scrollHeight=$(document).height()>$(window).height()?$(document).height()-$(window).height():0;var scrollTop=$(window).scrollTop();var scrollBottom=scrollHeight-scrollTop;if(scrollBottom<=advance&&maxHeight<scrollHeight){maxHeight=scrollHeight;scrollLoading=true;getCommodityInfoReplays({type:false,loadFromCache:false,limit:0})}}}var lastReviewTime="";function getCommodityInfoReplays(obj){!window.reviewByCommodity?window.reviewByCommodity=[]:"";var content_2=$("#reviewList");var content_2_clone=$("#review_clone");var tmpClone;var limit=obj.limit;if(obj.type){content_2.empty()}var data={appId:sessionStorage.appId||getQueryString("shopId"),commodityId:sessionStorage.commodityId_2||getQueryString("commodityId"),lastReviewTime:lastReviewTime};if(obj.loadFromCache&&window.reviewByCommodity.length>0){setData(window.reviewByCommodity);scrollLoading=false}else{if(window.getAjax_2){window.getAjax_2.abort();getAjax()}else{getAjax()}}function getAjax(){window.getAjax_2=getDataAjax({url:"/Mobile/GetReviewByCommodityId",data:obj.inData||data,beforeSend:function(){},callback:function(data){if(data.length){var time=data[data.length-1].SubTime.match(/\d/g).join("");lastReviewTime=getFormatDate(new Date(Number(time)));window.reviewByCommodity=window.reviewByCommodity.concat(data);setData(data)}scrollLoading=false}})}function setData(data){var dataCnt=data.length;if(limit&&limit<data.length){dataCnt=limit}for(var i=0;i<dataCnt;i++){tmpClone=content_2_clone.clone().removeClass("noDisplay").removeAttr("id");tmpClone.find(".user").text(data[i].Name.replace(/null/gi,""));tmpClone.find(".cmt_cnt").text(data[i].Details);tmpClone.find(".date").text(data[i].ShowTime);tmpClone.find(".cmt_sku1").text(data[i].Size?data[i].Size.replace(/null/gi,""):"");var li=$("<li></li>");li.append(tmpClone);content_2.append(li)}}}function getDataAjax(obj){var requestAsync=true;if(obj.async===false){requestAsync=false}return $.ajax({url:obj.url,type:"get",async:requestAsync,contentType:"application/json",data:obj.data,success:obj.callback,beforeSend:obj.beforeSend,error:function(e){if(e.status){toast("网络异常，请重试~");
obj.error&&obj.error()}},complete:obj.complete,dataType:"json"})}function getDataAjax2(obj){var requestAsync=true;if(obj.async===false){requestAsync=false}if(obj.data&&$.type(obj.data)!="string"){obj.data=JSON.stringify(obj.data)}$.ajax({url:obj.url,type:"post",async:requestAsync,contentType:"application/json",data:obj.data,success:obj.callback,beforeSend:obj.beforeSend,error:function(e){if(e.status){toast("网络异常，请重试~");obj.error&&obj.error()}},complete:obj.complete,dataType:"json"})}function getDataAjax3(obj){return $.ajax({url:obj.url,type:"post",data:obj.data,success:obj.success,beforeSend:obj.beforeSend,error:function(e){if(e.status){toast("网络异常，请重试~");obj.error&&obj.error()}},complete:obj.complete,dataType:"json"})}function getCommodity(obj){csson($("#cdefault"));var data={appId:obj.appId,pageIndex:obj.pageIndex,pageSize:obj.pageSize,promotionId:getQueryString("promotionId")};if(!obj.appId||obj.appId==null||obj.appId=="null"||obj.appId=="undefined"||obj.appId==undefined){return}if((sessionStorage.ProductType=="appcjzy"||sessionStorage.ProductType=="webcjzy")&&JsVilaDataNull(getCookie("selectCityCode"))){data.areaCode=getCookie("selectCityCode")||""}return getDataAjax({url:"/Mobile/GetCommodity",data:data,beforeSend:obj.beforeSend,callback:obj.callback})}function setItemData(obj){var clone_item=obj.element;var data=obj.data;if(window.itemIdList){if(window.itemIdList[data.Id]){return""}window.itemIdList[data.Id]="on"}else{window.itemIdList={};window.itemIdList[data.Id]="on"}clone_item.css({}).attr("data-id",data.Id);clone_item.find(".img").parent().css({"height":Math.round(sessionStorage.img_height)+"px","overflow":"hidden"}).find(".img").css("height",Math.round(sessionStorage.img_height)+"px").attr("src",data.Pic).addClass("LazyLoad")[0].onerror=function(){console.log(self.css({background:"none"}).attr("src","/Content/Mobile/b_2.png"))};clone_item.find(".selfTakeImg").parent().css({"height":Math.round(sessionStorage.img_height)+"px","overflow":"hidden"}).find(".selfTakeImg").css("height",Math.round(sessionStorage.img_height)+"px");clone_item.find(".item_title").text(data.Name,8,"...");var isyou=false;if(data.DiscountPrice>0){clone_item.find(".price_1").text(getCurrency()+Math.abs(data.DiscountPrice).toFixed(2));clone_item.find(".price_2").text(getCurrency()+data.Price);clone_item.find(".zk").text("优惠价");isyou=true}else{if(data.Intensity==10){clone_item.find(".price_1").text(getCurrency()+data.Price);if(data.MarketPrice&&data.MarketPrice!=null&&data.MarketPrice!="null"){clone_item.find(".price_2").text(getCurrency()+data.MarketPrice)}else{clone_item.find(".price_2").hide()}}else{clone_item.find(".price_1").text(getCurrency()+Math.abs(data.Price*(data.Intensity/10)).toFixed(2));clone_item.find(".price_2").text(getCurrency()+data.Price);isyou=true}data.Intensity!=10?clone_item.find(".zk").text(data.Intensity+"折"):""}var lim="";if(isyou==true&&sessionStorage.ProductType!="appcjzy"&&sessionStorage.ProductType!="webcjzy"){if(data.LimitBuyEach>-1&&data.LimitBuyEach){lim+="每人限购"+data.LimitBuyEach+"件,"}else{lim+="不限购,"}if(data.LimitBuyTotal>-1&&data.LimitBuyTotal){lim+="还剩"+(parseInt(data.LimitBuyTotal)-parseInt(data.SurplusLimitBuyTotal))+"件"}else{lim+="还剩"+data.Stock+"件"}clone_item.find(".yhzknum").text(lim)}!(data.Stock>0)?clone_item.find(".mb_box").removeClass("noDisplay"):"";data.State==1?clone_item.find(".mb_box").removeClass("noDisplay").find(".mb_1").text("已下架"):"";data.IsEnableSelfTake==1?clone_item.find(".selfTake").removeClass("noDisplay"):clone_item.find(".selfTake").addClass("noDisplay");return clone_item}function getCommodityItem_ListMode(obj){var alen=$("#itemsListMode a[data-id='"+obj.data.Id+"']").length;if(alen>0){return""}var data={};$.extend(data,obj.data);data.Price_1="0.00";data.Price_2="0.00";data.Price_2_Display="inlline-block";data.LimitBuy="";data.FloatMsg="已售完";data.FloatMsg_Display="block";var isyou=false;if(data.DiscountPrice>0){data.Price_1=Math.abs(data.DiscountPrice).toFixed(2);data.Price_2=data.Price;isyou=true}else{if(data.Intensity==10){data.Price_1=data.Price;if(data.MarketPrice&&data.MarketPrice!=null&&data.MarketPrice!="null"){data.Price_2=data.MarketPrice}else{data.Price_2_Display="none"}}else{data.Price_1=Math.abs(data.Price*(data.Intensity/10)).toFixed(2);data.Price_2=data.Price;isyou=true}}var lim="";if(isyou==true&&sessionStorage.ProductType!="appcjzy"&&sessionStorage.ProductType!="webcjzy"){if(data.LimitBuyEach>-1&&data.LimitBuyEach){lim+="每人限购"+data.LimitBuyEach+"件,"}else{lim+="不限购,"}if(data.LimitBuyTotal>-1&&data.LimitBuyTotal){lim+="还剩"+(parseInt(data.LimitBuyTotal)-parseInt(data.SurplusLimitBuyTotal))+"件"}else{lim+="还剩"+data.Stock+"件"}}data.LimitBuy=lim;if(data.Stock<=0){data.FloatMsg_Display="block";if(data.State==1){data.FloatMsg="已下架"}else{data.FloatMsg="已售完"}}else{data.FloatMsg_Display="none"}if(data.IsEnableSelfTake==1){data.SelfTakeDisplay="inline-block"}else{data.SelfTakeDisplay="none"}data.srckey="src";var cItemHtml=$("#divCommodityItemListMode").html();cItemHtml=cItemHtml.format(data);
return cItemHtml}function csson(obj){$(".toporder ul li").each(function(i){$(this).removeClass("topon")});$(obj).addClass("topon")}var _commodityListData=new Array();function ComOrderList(fieldSort,order,state){var data={categoryId:"11111111-1111-1111-1111-111111111111",appId:sessionStorage.appId,pageIndex:sessionStorage.page,pageSize:10,fieldSort:fieldSort,order:order};var areaCode="";if((sessionStorage.ProductType=="appcjzy"||sessionStorage.ProductType=="webcjzy")&&JsVilaDataNull(getCookie("selectCityCode"))){data.areaCode=getCookie("selectCityCode")||""}getDataAjax({url:"/Mobile/GetOrByCommodity",data:data,callback:function(data){window.itemIdList={};if(state==1){$("#items").html("");$("#itemsListMode").html("");_commodityListData=[]}sessionStorage.data=JSON.stringify(data);_commodityListData=_commodityListData.concat(data);var items=$("#items");var item=$("#parent_item");var height=item.height();var img_height=item.find("img").height();var clone_item;var itemsListMode=$("#itemsListMode");for(var i=0;i<data.length;i++){clone_item=item.clone().removeClass("noDisplay").attr("id","");var ghParam={element:clone_item,data:data[i],height:height,img_height:img_height};items.append(setItemData(ghParam));var html=getCommodityItem_ListMode(ghParam);itemsListMode.append(html)}$("#ajaxLoadBlind").remove();showLazyLoadImg();if(data.length>=10){$("#footer_loading").show().find("span").text("获取更多信息")}},beforeSend:function(){},error:function(){$("#ajaxLoadBlind").remove()}})}function getCommodityByCategory(categoryId){window.itemIdList={};var items=$("#items");var item=$("#parent_item");var height=item.height();var img_height=item.find("img").height();var clone_item;var $footer_loading=$("#footer_loading");var $top_loading=$("#top_loading");var type=false;var itemsListMode=$("#itemsListMode");if(!sessionStorage.categoryLock){items.empty();itemsListMode.empty();_commodityListData=[]}if(categoryId){sessionStorage.categoryId=categoryId;var data={categoryId:categoryId,appId:sessionStorage.appId,pageIndex:sessionStorage.page,pageSize:10};getDataAjax({url:"/Mobile/GetCommodityByCategory",data:data,beforeSend:function(){$footer_loading.find("span").text("正在获取信息...")},callback:function(data){if(data.length){for(var i=0;i<data.length;i++){clone_item=item.clone().removeClass("noDisplay").removeAttr("id");var ghParam={element:clone_item,data:data[i],height:height,img_height:img_height};items.append(setItemData(ghParam));var html=getCommodityItem_ListMode(ghParam);itemsListMode.append(html)}showLazyLoadImg();sessionStorage.page++}else{if(data.length>10){$footer_loading.removeClass("clicks_lock").find("span").text("没有更多商品")}}if(data.length<10){$footer_loading.hide()}else{$footer_loading.removeClass("clicks_lock").show().find("span").text("获取更多信息")}$top_loading.find("span").text("已更新");type=true}})}else{$footer_loading.hide();items.html('<div style="text-align: center;line-height: 20em;">暂无信息</div>')}$("#Commodity_nav").css("left","-"+$("#Commodity_nav").width()+"px");return type}function getNavList(){var l_length=0;var data={appId:sessionStorage.appId};var li=$("<li></li>");var nav_list=$("#nav_list");nav_list.html("");if(nav_list.length){getNavObj()}function getNavObj(){nav_list=$("#nav_list");setTimeout(function(){if(nav_list.length){getNavObj()}},500)}if(sessionStorage.commodityNavList){if(sessionStorage.commodityNavList.length){setItem(JSON.parse(sessionStorage.commodityNavList))}else{getAjax()}}else{getAjax()}function getAjax(){getDataAjax({url:"/Mobile/GetCategory",data:data,callback:function(data){sessionStorage.commodityNavList=JSON.stringify(data);localStorage.commodityNavList=JSON.stringify(data);setItem(data)},error:function(){if(l_length<3){l_length++;getAjax()}else{setItem(JSON.parse(localStorage.commodityNavList))}}})}function setItem(data){var show_item_key=0;for(var i=0;i<data.length;i++){nav_list.append(li.clone().addClass("nav_one").text(data[i].Name).data("category-id",data[i].Id));for(var b=0;b<data[i].SecondCategory.length;b++){nav_list.append(li.clone().addClass("nav_two nav_inner").text(data[i].SecondCategory[b].Name).data("parent-name",data[i].Name).data("show-item",show_item_key).data("category-id",data[i].SecondCategory[b].Id).append($('<span class="nav_inners"></span>')));for(var c=0;c<data[i].SecondCategory[b].ThirdCategory.length;c++){nav_list.append(li.clone().addClass("nav_two hidden").text(data[i].SecondCategory[b].ThirdCategory[c].Name).data("show-key",show_item_key).data("category-id",data[i].SecondCategory[b].ThirdCategory[c].Id))}show_item_key++}}nav_list.append(li.clone().addClass("nav_one").text("未分类").data("category-id","00000000-0000-0000-0000-000000000000"))}}function getWantCommodityData(want){var items=$("#items");var item=$("#parent_item");var height=item.height();var img_height=item.find("img").height();var clone_item;var $footer_loading=$("#footer_loading");var $top_loading=$("#top_loading");var type=false;var itemsListMode=$("#itemsListMode");window.itemIdList={};if(!sessionStorage.wantLock){items.empty();
itemsListMode.empty();_commodityListData=[]}sessionStorage.want=want;var data={want:want,appId:sessionStorage.appId,pageIndex:sessionStorage.page,pageSize:10};getDataAjax({url:"/Mobile/GetWantCommodity",data:data,callback:function(data){if(data.length){for(var i=0;i<data.length;i++){clone_item=item.clone().removeClass("noDisplay").attr("id","");items.append(setItemData({element:clone_item,data:data[i],height:height,img_height:img_height}))}showLazyLoadImg();sessionStorage.page++}else{if(data.length>10){$footer_loading.removeClass("clicks_lock").find("span").text("没有更多商品")}}if(data.length<10){$footer_loading.hide()}else{$footer_loading.removeClass("clicks_lock").show().find("span").text("获取更多信息")}type=true;$top_loading.find("span").text("已更新")}});return type}function CommodityList(){$(function(){sessionStorage.page=1;new TouchMoveEvent();navEvent();if(sessionStorage.appId&&sessionStorage.appId!="undefined"&&sessionStorage.appId!="null"){}else{sessionStorage.appId=getQueryString("shopId")||appId}if(getQueryString("sortType")=="New"&&sessionStorage.ComTypeSearch!=1){sessionStorage.appId=getQueryString("shopId");csson($("#cnewcom"));ajaxLoading("22","");sessionStorage.page=1;sessionStorage.ComTypeSearch=4;ComOrderList(2,0,1)}else{getAjaxData()}function getAjaxData(){getCommodity({appId:sessionStorage.appId,pageIndex:sessionStorage.page,pageSize:10,callback:function(data){sessionStorage.data=JSON.stringify(data);_commodityListData=_commodityListData.concat(data);if(!data||data.length==0){$("#findNone").show();return}else{$("#findNone").hide()}var items=$("#items");var item=$("#parent_item");var height=item.height();var img_height=item.find("img").height();var clone_item;var itemsListMode=$("#itemsListMode");for(var i=0;i<data.length;i++){clone_item=item.clone().removeClass("noDisplay").attr("id","");var ghParam={element:clone_item,data:data[i],height:height,img_height:img_height};items.append(setItemData(ghParam));var html=getCommodityItem_ListMode(ghParam);itemsListMode.append(html)}showLazyLoadImg();if(data.length>=10){$("#footer_loading").show().find("span").text("获取更多信息")}if(getQueryString("promotionId")!=""&&getQueryString("promotionId")!=undefined){$(".toporder").addClass("noDisplay")}}})}});var touchLock=true;function newTouchMoveEvent(){var nav=document.getElementById("Commodity_nav"),$nav=$(nav),navStartLeft,navWidth=$nav.css({position:"absolute",visibility:"hidden",display:"block"}).width(),navMoveAutoMinSize=20,starSize;$nav.css({position:"fixed",visibility:"inherit",display:"none",left:-navWidth,height:$(window).height()});touch.config({tap:true,doubleTap:true,hold:true,holdTime:650,swipe:true,swipeTime:300,swipeMinDistance:18,swipeFactor:5,drag:true,pinch:true});touch.on("body","swipestart",function(ev){starSize=ev.x;navStartLeft=parseInt(nav.style.left)});touch.on("body","touchmove",function(e){});touch.on("body","swiping",function(ev){if(Math.abs(ev.x)>navMoveAutoMinSize){nav.style.left=navStartLeft+ev.x-navMoveAutoMinSize+"px";nav.style.display="block";nav.style.zIndex="3"}});touch.on("body","swipeend",function(ev){var left=Math.abs(parseInt(nav.style.left));if(starSize-ev.x<0){if(left>navWidth-navMoveAutoMinSize){nav.style.left=-navWidth+"px"}else{nav.style.left="0px"}}else{if(left<navMoveAutoMinSize){nav.style.left="0px"}else{nav.style.left=-navWidth+"px"}}});function getStyle(obj,styleName){return document.defaultView.getComputedStyle(obj,false)[styleName]}}function TouchMoveEvent(){var body=document.getElementsByTagName("body")[0];var main=document.getElementById("main");var box=document.getElementById("box");var nav=document.getElementById("Commodity_nav");var top_loading=document.getElementById("top_loading");var footer_loading=document.getElementById("footer_loading");var $main=$(main);var $body=$(body);var $nav=$(nav);var $box=$(box);var $top_loading=$(top_loading);var $footer_loading=$(footer_loading);var startPageX=0;var startPageY=0;var top_loading_start_size=0;var moveSize=0;var moveSizeY=0;var moveYMax=10;var moveXMax=10;var startY=document.body.scrollTop;var startX=document.body.scrollLeft;var startNavLeft=0;var boxLeft=0;var touchMoveMinSize=20;var touchMoveMaxSize=parseInt($nav.width());var lockY=true;var lockX=false;var lockInnerX=true;var mainLock=true;var navScrollStart=0;var navScrollTop=0;var navMove=0;var footerLoadingLock=false;var topLoadingLock=false;var type={};var lock=true;var testBox=$('<div id="testBox"></div>').css({position:"fixed",top:0,height:"200px",width:"300px",left:0,zIndex:999,backgroundColor:"#fff"});$nav.css({zIndex:3});body.addEventListener("touchstart",function(e){var touch=e.changedTouches[0];startPageX=touch.screenX;startPageY=touch.screenY;boxLeft=parseInt($(box).css("left"));box.style.left=boxLeft+"px";startNavLeft=parseInt($nav.css("left"));lockX=false;lockY=true;startY=body.scrollTop;top_loading_start_size=parseInt($top_loading.css("margin-top"));footerLoadingLock=false;topLoadingLock=false;$nav.css({height:$(window).height()});if(parseInt($nav.css("left"))>-20){lockY=false;
lockX=true}if($(document).height()>$(window).height()){type.h=$(document).height()-$(window).height()}else{type.h=$(window).height()-$(document).height()}touchMoveMaxSize=parseInt($nav.width())});body.addEventListener("touchmove",function(e){var touch=e.changedTouches[0];moveSize=touch.screenX-startPageX;moveSizeY=touch.screenY-startPageY;if(Math.abs(moveSize)>moveXMax&&Math.abs(moveSizeY)<moveYMax){lockY=false;e.preventDefault();lockX=true}if(lockY){if(startNavLeft==0){$nav.css({left:0})}else{$nav.css({left:-touchMoveMaxSize+"px"})}if(startY==0&&moveSizeY>0){var top_move=top_loading_start_size+moveSizeY;if(top_move<=0){e.preventDefault();$top_loading.css({marginTop:top_move})}else{$top_loading.css({marginTop:0}).find("span").text("松开可更新");topLoadingLock=true}}if($body.scrollTop()==type.h){if(moveSizeY<-10&&$footer_loading.find("span").text()!="正在获取信息..."){$footer_loading.find("span").text("松开可更新");e.preventDefault();footerLoadingLock=true}}else{}}if(lockX){if(Math.abs(moveSizeY)<10){e.preventDefault();$nav.show();var ll=startNavLeft+moveSize;if(ll<0){$nav.css({left:startNavLeft+moveSize+"px"})}body.scrollTop=startY}}});body.addEventListener("touchend",function(e){touchMoveMaxSize=parseInt($nav.width());type.moveEnd=new Date().getTime();var touch=e.changedTouches[0];var mo=startPageX-touch.screenX;var items=$("#items");if(topLoadingLock){_commodityListData=[];setUpListItem()}else{$top_loading.css("margin-top","-"+$top_loading.css("height"))}if(footerLoadingLock){var bnext=false;switch(sessionStorage.ComTypeSearch){case"2":bnext=true;sessionStorage.page++;ComOrderList(1,sessionStorage.PriceState,0);break;case"3":bnext=true;sessionStorage.page++;ComOrderList(0,0,0);break;case"4":bnext=true;sessionStorage.page++;ComOrderList(2,0,0);break}if(bnext==false){setDownListItem()}}if(lockX){var n_left=parseInt($nav.css("left"));if(mo>0){if(Math.abs(n_left)>20){$nav.css("left",-touchMoveMaxSize+"px")}else{$nav.css("left",0)}}else{if(Math.abs(n_left)>touchMoveMaxSize-20){$nav.css("left",-touchMoveMaxSize+"px")}else{$nav.css("left",0)}}}moveSizeY=0;moveSize=0});function setUpListItem(){if(sessionStorage.categoryId){$top_loading.find("span").text("正在获取信息...");$("#items").empty();$("#itemsListMode").empty();_commodityListData=[];sessionStorage.page=1;sessionStorage.categoryLock=true;getCommodityByCategory(sessionStorage.categoryId);setTimeout(function(){$top_loading.css("margin-top","-"+$top_loading.css("height")).find("span").text("下拉可刷新")},1000)}else{if(sessionStorage.want){$top_loading.find("span").text("正在获取信息...");$("#items").empty();$("#itemsListMode").empty();_commodityListData=[];sessionStorage.page=1;sessionStorage.wantLock=true;getWantCommodityData(sessionStorage.want);setTimeout(function(){$top_loading.css("margin-top","-"+$top_loading.css("height")).find("span").text("下拉可刷新")},1000)}else{getCommodity({appId:sessionStorage.appId,pageIndex:1,pageSize:10,beforeSend:function(){$top_loading.find("span").text("正在获取信息...")},callback:function(data){var items=$("#items").empty();var itemsListMode=$("#itemsListMode").empty();var item=$("#parent_item");var height=item.height();var img_height=item.find("img").height();var clone_item;_commodityListData=[];window.itemIdList={};for(var i=0;i<data.length;i++){clone_item=item.clone().removeClass("noDisplay").attr("id","");var ghParam={element:clone_item,data:data[i],height:height,img_height:img_height};items.append(setItemData(ghParam));var html=getCommodityItem_ListMode(ghParam);itemsListMode.append(html)}$top_loading.find("span").text("已更新");sessionStorage.data=JSON.stringify(data);_commodityListData=_commodityListData.concat(data);sessionStorage.page=1;setTimeout(function(){$top_loading.css("margin-top","-"+$top_loading.css("height")).find("span").text("下拉可刷新")},1000);$footer_loading.show()}})}}}$footer_loading.on("click",function(){if($footer_loading.find("span").text()!="正在获取信息..."){var bnext=false;switch(sessionStorage.ComTypeSearch){case"2":bnext=true;sessionStorage.page++;ComOrderList(1,sessionStorage.PriceState,0);break;case"3":bnext=true;sessionStorage.page++;ComOrderList(0,0,0);break;case"4":bnext=true;sessionStorage.page++;ComOrderList(2,0,0);break}if(bnext==false){setDownListItem()}}});function setDownListItem(){var w=$("#Commodity_nav").css("left");w=w.indexOf("%")>-1?parseInt(w.replace("%",""))/100*$(window).width():parseInt(w);if(Math.abs(w)+5<Math.round($(window).width()*0.6)){return 0}window.ajax;if(!sessionStorage.categoryId&&!sessionStorage.want){sessionStorage.page==1?sessionStorage.page++:"";if(lock){if(window.ajax){window.ajax.abort();sendAjax()}else{sendAjax()}}function sendAjax(){window.ajax=getCommodity({appId:sessionStorage.appId,pageIndex:sessionStorage.page,pageSize:10,beforeSend:function(){$footer_loading.find("span").text("正在获取信息...")},callback:function(data){lock=true;var items=$("#items");var item=$("#parent_item");var itemsListMode=$("#itemsListMode");var height=item.height();var img_height=item.width()/item.find("img").width();var clone_item;_commodityListData=_commodityListData.concat(data);
setTimeout(function(){if(data.length){for(var i=0;i<data.length;i++){clone_item=item.clone().removeClass("noDisplay").attr("id","");var ghParam={element:clone_item,data:data[i],height:height,img_height:img_height};items.append(setItemData(ghParam));var html=getCommodityItem_ListMode(ghParam);itemsListMode.append(html)}showLazyLoadImg();sessionStorage.page++;if(data.length>=10){$footer_loading.removeClass("clicks_lock").find("span").text("获取更多信息")}else{$footer_loading.removeClass("clicks_lock").find("span").text("没有更多商品")}}else{$footer_loading.removeClass("clicks_lock").find("span").text("没有更多商品")}},500)}})}lock=false}else{if(sessionStorage.categoryId){sessionStorage.categoryLock=true;getCommodityByCategory(sessionStorage.categoryId)}else{if(sessionStorage.want){sessionStorage.wantLock=true;getWantCommodityData(sessionStorage.want)}}}}nav.addEventListener("touchstart",function(e){var touch=e.changedTouches[0];navScrollStart=touch.pageY});nav.addEventListener("touchmove",function(e){e.preventDefault();var touch=e.changedTouches[0];navMove=touch.pageY-navScrollStart;nav.scrollTop=navScrollTop-navMove});nav.addEventListener("touchend",function(e){navScrollTop=nav.scrollTop;touchLock=!navMove;navMove=0});$box.on("click",".item_1,a.item",function(e){if($(e.target).is(".zcz")){tanchucrowd()}else{if($(e.target).is("span.shopping-cart")){_commodityItemRootElement=$(this);DealLoginPartial.initPartialPage()}else{if(Math.abs(moveSizeY)<10&&!lockX){ajaxLoading("22","");var self=$(this);var box_2=$("#box_2");sessionStorage.commodityId_2=self.data("id");window.location.href=urlAppendCommonParams("/Mobile/CommodityDetail?commodityId="+self.data("id")+"&type=show")}}}})}function navEvent(){var parentUl;var parentUlClone={};$("#Commodity_nav").on("click",".nav_inner",function(){if(touchLock){var self=$(this);parentUl=self.parents("ul");parentUlClone=parentUl.clone();var self_name=self.data("parent-name");var item_key=self.data("show-item");var one_li='<li class="nav_one" data-category-id="{id}">{text}</li>';var two_li='<li class="nav_two" data-category-id="{id}">{text}</li>';parentUl.empty();parentUl.append(one_li.replace("{text}",self_name+"<span>></span>"+self.text()).replace("{id}",self.data("category-id")));parentUlClone.find(".hidden").each(function(){if($(this).data("show-key")==item_key){parentUl.append(two_li.replace("{text}",$(this).text()).replace("{id}",$(this).data("category-id")))}})}}).on("click",".title",function(){window.itemIdList={};if(parentUl){var ul_parent=parentUl.parent();ul_parent.find("ul").remove();parentUlClone.find("li").removeClass("nav_focus");ul_parent.append(parentUlClone)}else{$(this).parent().find("li").removeClass("nav_focus")}var items=$("#items").empty();var itemsListMode=$("#itemsListMode").empty();_commodityListData=[];getCommodity({appId:sessionStorage.appId,pageIndex:1,pageSize:10,callback:function(data){sessionStorage.data=JSON.stringify(data);sessionStorage.categoryId="";sessionStorage.categoryLock="";sessionStorage.want="";sessionStorage.wantLock="";_commodityListData=_commodityListData.concat(data);sessionStorage.page=1;var item=$("#parent_item");var height=item.height();var img_height=item.find("img").height();var clone_item;for(var i=0;i<data.length;i++){clone_item=item.clone().removeClass("noDisplay").attr("id","");items.append(setItemData({element:clone_item,data:data[i],height:height,img_height:img_height}))}showLazyLoadImg();if(data.length>=10){$("#footer_loading").show().find("span").text("获取更多信息")}parentUl=""}})}).on("click","li",function(){if(touchLock){var self=$(this);var parent=self.parent();if(!self.hasClass("no_nav_focus")){parent.find("li").removeClass("nav_focus");if(!self.hasClass("no_nav_focus")){self.addClass("nav_focus")}if(!self.hasClass("nav_inner")){sessionStorage.page=1;sessionStorage.ComTypeSearch=0;sessionStorage.categoryLock="";getCommodityByCategory(self.data("category-id"))}}}}).on("keydown","input",function(e){var self=$(this);if(e.keyCode==13){sessionStorage.page=1;sessionStorage.categoryLock="";getWantCommodityData(self.val());self[0].blur()}});$("#nav_search_click").on("click",function(){sessionStorage.ComTypeSearch=0;sessionStorage.page=1;getWantCommodityData($("#Commodity_nav").find("input").val())})}}function showLazyLoadImg(){}function setSessionStorageItemHeightAndImgHeight(){var imgs=document.createElement("img");imgs.src="/Content/Mobile/1.png?"+new Date().getTime();imgs.onload=function(){var parent_item=$("#parent_item").clone().show();$("body").append(parent_item);sessionStorage.img_height=Math.round(parent_item.width()/this.width*this.height);parent_item.find(".position_r").append(imgs);sessionStorage.item_height=parent_item.height()-15;parent_item.remove()}}function getOrder(obj){var data={userId:getQueryString("userId"),pageIndex:obj.pageIndex,pageSize:obj.pageSize,state:obj.orderState,esAppId:getEsAppId()};return getDataAjax({url:"/Mobile/GetOrder",data:data,beforeSend:obj.beforeSend,callback:obj.callback})}function getOrderListHtml(data){if(data==null||data.length==0){return""
}var len=data.length;var allHtml="";for(var i=0;i<len;i++){allHtml+=getOrderItemHtml(data[i])}return allHtml}function getOrderItemHtml(data){var ciHtml="";if(data.ShoppingCartItemSDTO&&data.ShoppingCartItemSDTO.length>0){var len=data.ShoppingCartItemSDTO.length;var reviewLength=0;for(var i=0;i<len;i++){var cartItem=data.ShoppingCartItemSDTO[i];if(Number(cartItem.Specifications)>0){cartItem.CommodityNumber=Number(cartItem.CommodityNumber/cartItem.Specifications);cartItem.Specifications=String("包装规格: 1*"+cartItem.Specifications+"")}else{cartItem.Specifications=""}cartItem.end=(i==len-1)?"end":"";cartItem.SelfTakeDisplay=data.SelfTakeFlag==1?"block":"none";cartItem.srckey="src";ciHtml+=commodityItemTemplate.format(cartItem);if(cartItem.HasReview){reviewLength++}}}var isReview=reviewLength>0?true:false;data.CommodityCount=len;data.CommodityItemsHtml=ciHtml;data.OperateButtonsHtml=getOneOrderButtonHtml(data,isReview);data.StateText=getOrderStateText(data.State,data.StateAfterSales);data.AppName=data.AppName==undefined?"":data.AppName;var html=shopItemTemplate.format(data);return html}function getAfterSaleState(afterSaleState){var text="";if(afterSaleState==3){text="交易成功"}else{if(afterSaleState==5){text="退款中"}else{if(afterSaleState==7){text="已退款"}else{if(afterSaleState==10){text="退款中"}else{if(afterSaleState==12){text="金和处理退款中"}else{if(afterSaleState==15){text="交易成功"}}}}}}return text}function getOrderStateText(state,afterSaleState){var text="";switch(state){case 0:text="待付款";break;case 1:text="待发货";break;case 13:text="出库中";break;case 2:text="已发货";break;case 3:text="交易成功";if(JsVilaDataNull(afterSaleState)){var asText=getAfterSaleState(afterSaleState);if(JsVilaDataNull(asText)){text=asText}}break;case 4:text="交易失败";break;case 5:text="交易失败";break;case 6:text="交易关闭";break;case 7:text="已退款";break;case 8:case 9:case 10:case 14:text="退款中";break;case 11:text="待发货";break;case 12:text="金和处理退款中";break;default:text="";break}return text}function getButtonByState(data,state,pay,orderItemState){var btnArr=new Array();switch(state){case 0:btnArr.push(0);btnArr.push(1);break;case 1:if(pay!=1){btnArr.push(2)}else{btnArr.push(1)}if(data.SelfTakeFlag==1){btnArr.push(4)}if(orderItemState==1){btnArr.push(30)}break;case 13:btnArr.push(4);if(pay!=1){btnArr.push(3)}break;case 2:btnArr.push(4);if(pay!=1){btnArr.push(3)}var myDate=new Date();var month=myDate.getMonth()+1<10?"0"+(myDate.getMonth()+1):myDate.getMonth()+1;var currentDate=myDate.getDate()<10?"0"+myDate.getDate():myDate.getDate();var eDate=myDate.getFullYear()+"-"+month+"-"+currentDate;var sDate=ChangeDateFormat(data.ShipmentsTime,2);var sArr=sDate.split("-");var eArr=eDate.split("-");var sRDate=new Date(sArr[0],sArr[1],sArr[2]);var eRDate=new Date(eArr[0],eArr[1],eArr[2]);var result=(eRDate-sRDate)/(24*60*60*1000)+1;if(result>=6&&result<=9&&!data.IsDelayConfirmTime){btnArr.push(11)}if(orderItemState===1){btnArr.push(30)}if(orderItemState===3){btnArr.push(30);btnArr.push(32)}break;case 3:if(orderItemState===1||orderItemState===3){btnArr.push(30)}if(data.StateAfterSales==3){btnArr.push(7);if(orderItemState===3){btnArr.push(31);btnArr.push(32)}else{if(data.OrderType==0||data.OrderType==1||data.OrderType==3){btnArr.push(23)}}}else{if(data.StateAfterSales==5){if(orderItemState===3){btnArr.push(32)}btnArr.push(24);btnArr.push(25)}else{if(data.StateAfterSales==7){btnArr.push(25);if(data.RefundType==1&&JsVilaDataNull(data.RefundExpCo)){btnArr.push(27)}}else{if(data.StateAfterSales==10){if(JsVilaDataNull(data.RefundExpCo)){btnArr.push(27)}else{btnArr.push(24);btnArr.push(26)}btnArr.push(25)}else{if(data.StateAfterSales==12){}else{if(data.StateAfterSales==13){btnArr.push(7)}else{if(data.StateAfterSales==15){btnArr.push(7)}}}}}}}break;case 4:btnArr.push(9);break;case 5:btnArr.push(9);break;case 6:btnArr.push(9);break;case 7:if(data.SelfTakeFlag!=1){btnArr.push(31);if(data.RefundType==1&&JsVilaDataNull(data.RefundExpCo)){btnArr.push(33)}}break;case 8:btnArr.push(30);btnArr.push(31);break;case 9:btnArr.push(30);btnArr.push(31);if(orderItemState==3){btnArr.push(32)}break;case 14:btnArr.push(30);btnArr.push(31);break;case 10:btnArr.push(31);if(JsVilaDataNull(data.RefundExpCo)){btnArr.push(33)}else{if(data.OrderRefundState==11){}else{btnArr.push(30);btnArr.push(32)}}break;case 11:btnArr.push(2);break;case 12:break;default:break}return btnArr}function getOneOrderButtonHtml(data,isReview){var btnArr=getButtonByState(data,data.State,data.PayType);if(btnArr.length==0){return""}if(isReview){var ind=btnArr.indexOf(7);if(ind>-1){btnArr.splice(ind,1)}}if(data.OrderType==1){isReview=false;var ind=btnArr.indexOf(7);if(ind>-1){btnArr.splice(ind,1)}}var ind01=btnArr.indexOf(2);if(ind01>-1){btnArr.splice(ind01,1)}var ind02=btnArr.indexOf(3);if(ind02>-1){btnArr.splice(ind02,1)}var ind03=btnArr.indexOf(9);if(ind03>-1){btnArr.splice(ind03,1)}var ind04=btnArr.indexOf(10);if(ind04>-1){btnArr.splice(ind04,1)}var ind05=btnArr.indexOf(12);if(ind05>-1){btnArr.splice(ind05,1)}var ind06=btnArr.indexOf(23);if(ind06>-1){btnArr.splice(ind06,1)
}var ind07=btnArr.indexOf(26);if(ind07>-1){btnArr.splice(ind07,1)}var ind08=btnArr.indexOf(27);if(ind08>-1){btnArr.splice(ind08,1)}var ind09=btnArr.indexOf(24);if(ind09>-1){btnArr.splice(ind09,1)}if(btnArr.length==0){return""}var btnHtml="";for(var i=0;i<btnArr.length;i++){btnHtml+=getOneButtonHtml(btnArr[i],data)}return btnHtml}function getOneButtonHtml(btnType,data){var btnText="";switch(btnType){case 0:btnText="付款";break;case 1:btnText="取消订单";break;case 2:btnText="退款";break;case 3:btnText="申请退款/退货";break;case 4:btnText="确认收货";break;case 5:btnText="撤销退款申请";break;case 6:btnText="撤销退款/退货申请";break;case 7:btnText="评价";break;case 8:btnText="查看退款详情";break;case 9:btnText="删除";break;case 10:btnText="退货方式";break;case 11:btnText="延长收货时间(3天)";break;case 12:btnText="查看退货方式";break;case 23:btnText="申请退款/退货";break;case 24:btnText="撤销退款/退货申请";break;case 25:btnText="查看退款详情";break;case 26:btnText="退货方式";break;case 27:btnText="查看退货方式";break;case 30:btnText="撤销退款/退货申请";break;case 31:btnText="退款详情";break;case 32:btnText="退货方式";break;case 33:btnText="查看退货方式";break}var fparam=new Object();fparam.btnText=btnText;fparam.orderId=data.CommodityOrderId;fparam.otag=btnType;fparam.appId=data.AppId;fparam.btnPrimary=btnType==0?"btn-primary":"";var btnTempHtml='<a href="javascript:void(0)" class="button {btnPrimary}" orderId="{orderId}" otag="{otag}" appId="{appId}" >{btnText}</a>';btnTempHtml=btnTempHtml.format(fparam);return btnTempHtml}function registOrderEvent(){$('div[ctag="shopItem"]').off("click","**");$('div[ctag="shopItem"]').on("click",function(e){var orderId=$(e.target).attr("orderId");orderId=orderId==null?$(e.currentTarget).attr("orderId"):orderId;var appId=$(e.target).attr("appId");appId=appId==null?$(e.currentTarget).attr("appId"):appId;var url=urlAppendCommonParams("MyOrderDetail?orderId="+orderId+"&shopId="+appId);var sessionId=null;if(typeof getSessionId=="function"){sessionId=getSessionId()}if(!sessionId&&typeof getQueryString=="function"){sessionId=getQueryString("sessionId")}if(sessionId){url+="&sessionId="+sessionId}var orderState=getQueryString("orderState");if(JsVilaDataNull(orderState)){url+="&orderState="+orderState}window.location.href=url})}var shopItemTemplate="";var commodityItemTemplate="";$(function(){shopItemTemplate=$("#shopItemTemplate").html();commodityItemTemplate=$("#commodityItemTemplate").html()});function setOrderItemData(obj){var clone_item=obj.element;var clone_orderItem=obj.ordeItem;var data=obj.data;clone_item.css({}).attr("data-id",data.CommodityOrderId);clone_item.find("a").attr("href","MyOrderDetail?orderId="+data.CommodityOrderId+"&shopId="+data.AppId);if(data.ShoppingCartItemSDTO&&data.ShoppingCartItemSDTO.length){var html="";for(var i=0;i<data.ShoppingCartItemSDTO.length;i++){var cartItem=data.ShoppingCartItemSDTO[i];if(i==0){html+="<li>"}html+='<div style="margin-top:5px;"><img src=\''+cartItem.Pic+'\' alt="" width="60" height="60">';html+=' <div class="title">'+cartItem.Name+'</div></div><div style="clear:both;"></div>';if(i==data.ShoppingCartItemSDTO.length-1){if(data.State==0){html+='<span  class="con">待付款</span>'}else{if(data.State==1){html+='<span  class="con">待发货</span>'}else{if(data.State==2){html+='<span  class="con">已发货</span>'}else{if(data.State==3){html+='<span  class="con">交易成功</span>'}else{if(data.State==4){html+='<span  class="con">交易失败</span>'}else{if(data.State==5){html+='<span  class="con">交易失败</span>'}else{if(data.State==6){html+='<span  class="con">交易关闭</span>'}else{if(data.State==7){html+='<span  class="con">已退款</span>'}else{if(data.State==8){html+='<span  class="con">退款中</span>'}else{if(data.State==9||data.State==14){html+='<span  class="con">退款中</span>'}else{if(data.State==10){html+='<span  class="con">退款中</span>'}else{if(data.State==11){html+='<span  class="con">待发货</span>'}else{if(data.State==12){html+='<span  class="con">金和处理退款中</span>'}else{if(data.State==13){html+='<span  class="con">出库中</span>'}}}}}}}}}}}}}}html+="</li>"}}clone_item.find(".list").prepend(html)}return clone_item}function getOrderNew(fn){var orderState=JsVilaDataNull(getQueryString("orderState"))?getQueryString("orderState"):null;getOrder({userId:getUserId(),pageIndex:sessionStorage.page,pageSize:10,orderState:orderState,callback:function(data){$("#ajaxLoadBlind").remove();sessionStorage.OrderState=getQueryString("orderState");$("#noOrder").hide();var items=$("#orderItems");if(sessionStorage.page==1){items.empty();sessionStorage.orderList=false}var prevlocalData=JSON.parse(sessionStorage.orderList);if(prevlocalData==false||prevlocalData.length==0){sessionStorage.orderList=JSON.stringify(data)}else{sessionStorage.orderList=JSON.stringify(prevlocalData.concat(data))}var html=getOrderListHtml(data);items.append(html);registOrderEvent();showLazyLoadImg();if(sessionStorage.page==1){var $top_loading=$("#top_loading");$top_loading.find("span").text("已更新");setTimeout(function(){$top_loading.css("margin-top","-"+$top_loading.css("height")).find("span").text("下拉可刷新")},1000)}if(data.length>=10){$("#footer_loading").show().find("span").text("正在获取数据...")
}else{$("#footer_loading").show().find("span").text("暂无更多订单数据!")}isOrderDataEnd=data.length<10;fn&&fn()}})}var isOrderDataEnd=false;function OrderList(){$(function(){sessionStorage.page=1;if(getQueryString("type")=="shuaxin"){sessionStorage.orderList=false}if(sessionStorage.OrderState!=getQueryString("orderState")){sessionStorage.orderList=false}if(sessionStorage.orderList&&sessionStorage.orderList!="false"){var data=JSON.parse(sessionStorage.orderList);if(data&&data.length){(function(){var items=$("#orderItems");sessionStorage.page=data.length%10==0?parseInt(data.length/10):parseInt(data.length/10)+1;var html=getOrderListHtml(data);items.append(html);registOrderEvent();showLazyLoadImg();if(data.length>=10){$("#footer_loading").show().find("span").text("正在获取数据...")}else{if(data.length>0){$("#footer_loading").show().find("span").text("暂无更多订单数据!")}}isOrderDataEnd=data.length<10})()}else{getOrderNew(function(){})}}else{getOrderNew(function(){})}})}function round2(number,fractionDigits){with(Math){return round(number*pow(10,fractionDigits))/pow(10,fractionDigits)}}function JsCrowdfund(){return;getDataAjax({url:"/Mobile/GetUserCrowdfundingBuy",data:{userId:getUserId(),appId:sessionStorage.appId},callback:function(data){$("#ajaxLoadBlind").remove();showCrowdfund(data)},beforeSend:function(){ajaxLoading("22","")},error:function(){$("#ajaxLoadBlind").remove()}})}function showCrowdfund(data){if(data==null){return}var perShareMoney=data.PerShareMoney;var money=data.Money;var currentShareCount=data.CurrentShareCount;var isActiveCrowdfunding=data.IsActiveCrowdfunding;var shareCountRemain=data.ShareCountRemain;var usergou=$(".span_4").html();if(isActiveCrowdfunding=="true"||isActiveCrowdfunding){$(".crowli").show();if((usergou/perShareMoney)>=shareCountRemain){$(".crowinfor").html("您已拥有全部剩余股点"+shareCountRemain+"股！")}else{var jianggu=parseInt(usergou/perShareMoney)+1;var chaprice=((perShareMoney*jianggu)-usergou).toFixed(2);$(".crowinfor").html("您再购买"+chaprice+"元商品就能获得"+jianggu+"股，坐等分红啦！")}}}function timer(timestamp,callback){$(".time-item").show();var day=0,hour=0,minute=0,second=0;var intDiff=parseInt((sessionStorage.startSecKillTime.split("(")[1].split(")")[0]-(new Date()).getTime())/1000);if(intDiff>=0){day=Math.floor(intDiff/(60*60*24));hour=Math.floor(intDiff/(60*60))-(day*24);minute=Math.floor(intDiff/60)-(day*24*60)-(hour*60);second=Math.floor(intDiff)-(day*24*60*60)-(hour*60*60)-(minute*60);if(minute<=9){minute="0"+minute}if(second<=9){second="0"+second}$("#minute_show").html("<s></s>"+minute);$("#second_show").html("<s></s>"+second)}else{$("#minute_show").html("<s></s>"+"00");$("#second_show").html("<s></s>"+"00");return}if(!intDiff){callback();return}window.setInterval(function(){intDiff=parseInt((sessionStorage.startSecKillTime.split("(")[1].split(")")[0]-(new Date()).getTime())/1000);if(intDiff>=0){day=Math.floor(intDiff/(60*60*24));hour=Math.floor(intDiff/(60*60))-(day*24);minute=Math.floor(intDiff/60)-(day*24*60)-(hour*60);second=Math.floor(intDiff)-(day*24*60*60)-(hour*60*60)-(minute*60);if(minute<=9){minute="0"+minute}if(second<=9){second="0"+second}$("#minute_show").html("<s></s>"+minute);$("#second_show").html("<s></s>"+second);if(!intDiff){callback();return}}else{$("#minute_show").html("<s></s>"+"00");$("#second_show").html("<s></s>"+"00");return}},1000)}var iosShareData="";var iosShareDataNew="";function shareAndroid(content,title,imgUrl,url,sourceType,shareType){var startWebviewVersion="1.0.0";if(!shareType){shareType=0}try{var shareurl="";var shareSquareUrl="";url=url.toLowerCase();url=url.replace(/&userid=[^&]*/g,"");url=url.replace(/\?userid=[^&]*&/g,"?");url=url.replace(/&sessionid=[^&]*/g,"");url=url.replace(/\?sessionid=[^&]*&/g,"?");url=url.replace(/&srcappid=[^&]*/g,"");url=url.replace(/\?srcappid=[^&]*&/g,"?");url=url.replace(/\?srctype=[^&]*&/g,"?");url=url.replace(/&srctype=[^&]*/g,"");url=url.replace(/\?srctagid=[^&]*&/g,"?");url=url.replace(/&srctagid=[^&]*/g,"");url=url.replace(/&user=[^&]*/g,"");url=url.replace(/\?user=[^&]*&/g,"?");url=url.replace(/&speader=[^&]*/g,"");url=url.replace(/\?speader=[^&]*&/g,"?");url=url.replace("&source=share&","&").replace("?source=share&","?").replace("&source=share","").replace("?source=share","").replace("?&","?");var tmpIndex=url.indexOf("?");if(tmpIndex<0){shareurl=url+"?source=share";shareSquareUrl=url}else{if(tmpIndex==url.length-1){shareurl=url+"source=share";shareSquareUrl=url.substr(0,url.length-1)}else{shareurl=url+"&source=share";shareSquareUrl=url}}if(JsVilaDataNull(sessionStorage.srcAppId)){var appIdUrl="srcAppId="+sessionStorage.srcAppId;shareurl+="&"+appIdUrl}if(url.indexOf("speader")<0&&JsVilaDataNull(sessionStorage.speader)){shareurl+="&speader="+sessionStorage.speader}iosShareData='{"shareurl":"'+shareurl+'","shareSquareUrl":"'+shareSquareUrl+'","content":"'+(content?content:"")+'","title":"'+(title?title:"")+'","imgUrl":"'+(imgUrl?imgUrl:"")+'","sourceType":"'+(sourceType?sourceType:"")+'"}';iosShareDataNew='{"shareurl":"'+shareurl+'","shareSquareUrl":"'+shareSquareUrl+'","content":"'+(content?content:"")+'","title":"'+(title?title:"")+'","imgUrl":"'+(imgUrl?imgUrl:"")+'","sourceType":"'+(sourceType?sourceType:"")+'","shareType":"'+shareType+'"}';
if(isNewerJhWebview(startWebviewVersion)){var base64=new Base64();var para='{"businessJson":"{\\"shareUrl\\":\\"'+shareurl+'\\",\\"shareSquareUrl\\":\\"'+shareSquareUrl+'\\",\\"shareContent\\":\\"'+content+'\\",\\"imgUrl\\":\\"'+imgUrl+'\\",\\"message\\":null,\\"actionName\\":null,\\"shareTitle\\":\\"'+title+'\\",\\"sourceType\\":8,\\"shareType\\":'+shareType+'}","businessType":0}';if(!$.os.ios){window.location.href="jhoabrowser://integralTypeUrl?args="+base64.encode(para)+"&tag="+base64.encode(Math.random().toString())}}else{window.appshare.getShareInfo(shareurl,shareSquareUrl,content,title,imgUrl,null,null,sourceType)}}catch(e){}}function shareIOS(){return iosShareData}function shareIOSNew(){return iosShareDataNew}function getVipPrice(){if(isComHasVipInfo){return}getDataAjax({url:"/Mobile/GetVipInfo",type:"get",contentType:"application/json",dataType:"json",async:false,data:{appId:sessionStorage.appId},callback:function(data){ajaxLoadingSingle.hide();if(!data||data.ResultCode!="0"){toast(data.Message);return}showVipPriceLogin(data.Data)},beforeSend:function(){ajaxLoadingSingle.show()},error:function(){ajaxLoadingSingle.hide()}})}function showVipPriceLogin(vipData){if(!vipData||!vipData.IsVipActive){$("#divVipMember").hide();return}$("#divVipMember").show();var commodityInfo=JSON.parse(sessionStorage.commodityInfo);commodityInfo.VipPromotion=vipData;sessionStorage.commodityInfo=JSON.stringify(commodityInfo);var price=commodityInfo.Price;var promotionType=commodityInfo.PromotionTypeNew;$("#noLoginText").hide();var tmpPrice=0;if(promotionType==9999){if(JsVilaDataNull(vipData)&&vipData.IsVip){var tmpPriceTest="";var minPriceShow=setSessionStorage.minPriceShow;var maxPrice=sessionStorage.maxPrice;if(minPriceShow){var minPrice=sessionStorage.minPrice;tmpPriceTest=(Number(vipData.Intensity)*Number(minPrice)/10).toFixed(2)+"-"}var vipMaxPrice=(Number(vipData.Intensity)*Number(maxPrice)/10).toFixed(2);tmpPriceTest=tmpPriceTest+vipMaxPrice;$("#vipPrice2 .spanPrice").html(tmpPriceTest);$("#divVipMember").show();$("#vipPrice").show();$("#vipPrice2").show();$("#notVipText").hide()}else{if(JsVilaDataNull(vipData)&&!vipData.IsVip){$("#divVipMember").show();$("#vipPrice").hide();$("#vipPrice2").hide();$("#notVipText").show()}else{$("#divVipMember").hide()}}}else{$("#divVipMember").hide()}}function gotoCreateOrder(createOrderType,diyGroupId,totalPrice){sessionStorage.PicturesPathModel="";sessionStorage.PicturesPathModelMobile="";sessionStorage.CreateOrderInfo="";sessionStorage.userSelfTake="";sessionStorage.removeItem("PicturesPathModel");sessionStorage.removeItem("PicturesPathModelMobile");sessionStorage.removeItem("CreateOrderInfo");sessionStorage.removeItem("userSelfTake");var url=urlAppendCommonParams("/Mobile/CreateOrder?esAppId="+getQueryString("esAppId")+"&type="+createOrderType);if(JsVilaDataNull(diyGroupId)){url=addParam("diyGroupId",diyGroupId,url)}if(JsVilaDataNull(totalPrice)){url=addParam("price",totalPrice,url)}if(JsVilaDataNull(sessionStorage.JcActivityId)){url=addParam("jcActivityId",sessionStorage.JcActivityId,url)}window.location.href=url}function gotoCreateOrder3(createOrderType,setMealId,totalPrice){sessionStorage.PicturesPathModel="";sessionStorage.PicturesPathModelMobile="";sessionStorage.CreateOrderInfo="";sessionStorage.userSelfTake="";sessionStorage.removeItem("PicturesPathModel");sessionStorage.removeItem("PicturesPathModelMobile");sessionStorage.removeItem("CreateOrderInfo");sessionStorage.removeItem("userSelfTake");var url=urlAppendCommonParams("/Mobile/CreateOrder?type="+createOrderType);if(JsVilaDataNull(setMealId)){url=addParam("setMealId",setMealId,url)}if(JsVilaDataNull(totalPrice)){url=addParam("price",totalPrice,url)}window.location.href=url}function gotoCreateOrder2(createOrderType,diyGroupId,totalPrice){sessionStorage.PicturesPathModel="";sessionStorage.PicturesPathModelMobile="";sessionStorage.CreateOrderInfo="";sessionStorage.userSelfTake="";sessionStorage.removeItem("PicturesPathModel");sessionStorage.removeItem("PicturesPathModelMobile");sessionStorage.removeItem("CreateOrderInfo");sessionStorage.removeItem("userSelfTake");var shopid=sessionStorage.appId;var url=urlAppendCommonParams("/Mobile/CYCreateOrder?shopId="+shopid+"&type="+createOrderType);console.log("diyGroupId=",diyGroupId,"url=",url);if(JsVilaDataNull(diyGroupId)){url=addParam("diyGroupId",diyGroupId,url)}if(JsVilaDataNull(totalPrice)){url=addParam("price",totalPrice,url)}window.location.href=url}function getCookie(name){var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");if(arr=document.cookie.match(reg)){return unescape(arr[2])}else{return null}}function sortNumber(a,b){return a-b};